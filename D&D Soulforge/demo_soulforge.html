<!DOCTYPE html>
<html lang="es" data-quality="medium">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soulforge - Prototipo Visual</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap');

    :root {
      --ambient-color: #1a1510;
      --highlight-color: #c9a959;
      --fog-mask: radial-gradient(circle 200px at center, transparent 0%, transparent 80%, black 100%);
      --transition-speed: 0.5s;
    }

    body {
      margin: 0;
      background: #050505;
      color: #e8e2d9;
      font-family: 'Inter', sans-serif;
      overflow: hidden;
      height: 100vh;
      user-select: none;
    }

    /* ═══════════════════════════════════════
       VIEWPORT & MAP 
       ═══════════════════════════════════════ */
    .game-viewport {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #0a0908;
      transition: filter 1s ease;
    }

    .map-container {
      position: absolute;
      width: 2000px;
      height: 2000px;
      left: 50%;
      top: 50%;
      margin-left: -1000px; /* Centrar */
      margin-top: -1000px;
      background: #2a231c;
      /* Patrón de mapa simulado */
      background-image: 
        radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05) 0%, transparent 60%),
        repeating-linear-gradient(45deg, rgba(0,0,0,0.1) 0px, rgba(0,0,0,0.1) 2px, transparent 2px, transparent 10px);
      transform-origin: center center;
      transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
      will-change: transform;
      box-shadow: 0 0 100px rgba(0,0,0,0.5);
    }

    /* Elementos del mapa (Simulados) */
    .map-feature {
      position: absolute;
      background: #3d342b;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .room-1 { left: 800px; top: 800px; width: 400px; height: 300px; }
    .room-2 { left: 1300px; top: 900px; width: 200px; height: 200px; border-radius: 50%; }
    .corridor { left: 1200px; top: 950px; width: 100px; height: 60px; }

    /* Niebla de Guerra (Simulada con Mask) */
    .fog-layer {
      position: absolute;
      inset: 0;
      background: #050505; /* Color de la niebla */
      z-index: 20;
      pointer-events: none;
      mask-image: var(--fog-mask);
      -webkit-mask-image: var(--fog-mask);
      mask-composite: exclude;
      -webkit-mask-composite: destination-out;
      transition: all 1s ease;
    }

    /* ═══════════════════════════════════════
       TOKENS & ANIMACIONES
       ═══════════════════════════════════════ */
    .token {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #1a1a1a;
      border: 2px solid var(--highlight-color);
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      z-index: 30;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: var(--highlight-color);
      transition: transform 0.3s cubic-bezier(0.3, 1.5, 0.5, 1);
      cursor: pointer;
    }

    /* Breathing effect */
    .token::after {
      content: '';
      position: absolute;
      inset: -4px;
      border-radius: 50%;
      border: 1px solid rgba(201, 169, 89, 0.3);
      animation: breathe 4s ease-in-out infinite;
    }

    @keyframes breathe {
      0%, 100% { transform: scale(1); opacity: 0.3; }
      50% { transform: scale(1.1); opacity: 0.6; }
    }

    .token:hover { transform: scale(1.15); z-index: 40; }

    .token-hero { left: 950px; top: 950px; background: url('https://api.dicebear.com/7.x/avataaars/svg?seed=Felix') center/cover; }
    .token-enemy { left: 1400px; top: 1000px; border-color: #ff4444; background: url('https://api.dicebear.com/7.x/bottts/svg?seed=Monster') center/cover; }

    /* ═══════════════════════════════════════
       PARTÍCULAS
       ═══════════════════════════════════════ */
    .particle {
      position: fixed;
      pointer-events: none;
      z-index: 25;
      opacity: 0.6;
      will-change: transform;
    }

    /* Lluvia */
    @keyframes rain-drop {
      0% { transform: translate3d(0, -10vh, 0); opacity: 0; }
      10% { opacity: 0.6; }
      90% { opacity: 0.6; }
      100% { transform: translate3d(-20px, 100vh, 0); opacity: 0; }
    }

    /* Brillo Mágico */
    @keyframes magic-float {
      0% { transform: translate3d(0,0,0) scale(0); opacity: 0; }
      50% { opacity: 0.8; }
      100% { transform: translate3d(0,-50px,0) scale(1.5); opacity: 0; }
    }

    /* ═══════════════════════════════════════
       UI DM (THE QUILL)
       ═══════════════════════════════════════ */
    .dm-ui {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 600px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .quill-bar {
      width: 100%;
      background: rgba(10, 10, 10, 0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 50px;
      padding: 15px 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
    }

    .quill-bar:focus-within {
      background: rgba(20, 20, 20, 0.95);
      border-color: var(--highlight-color);
      box-shadow: 0 0 20px rgba(201, 169, 89, 0.2);
      width: 650px;
    }

    .quill-input {
      background: transparent;
      border: none;
      color: #fff;
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      width: 100%;
      outline: none;
    }
    .quill-input::placeholder { color: rgba(255,255,255,0.3); }

    .suggestion-pill {
      position: absolute;
      top: -40px;
      background: var(--highlight-color);
      color: #000;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }
    .suggestion-pill.visible { opacity: 1; transform: translateY(0); }

    .help-text {
      font-size: 11px;
      color: rgba(255,255,255,0.3);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* ═══════════════════════════════════════
       EFECTOS GLOBALES (MOODS)
       ═══════════════════════════════════════ */
    /* DANGER */
    body[data-mood="danger"] .game-viewport {
      box-shadow: inset 0 0 150px rgba(100, 0, 0, 0.3);
    }
    body[data-mood="danger"] .map-container {
      animation: heartbeat 1.5s ease-in-out infinite;
    }
    
    @keyframes heartbeat {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(0.8) sepia(0.5) hue-rotate(-50deg); }
    }

    /* COLD */
    body[data-mood="cold"] .game-viewport {
      filter: sepia(0.4) hue-rotate(180deg) saturate(0.6);
    }

    /* TEXTO NARRATIVO FLOTANTE */
    .narrative-float {
      position: fixed;
      top: 20%;
      width: 100%;
      text-align: center;
      font-family: 'Cinzel', serif;
      font-size: 2rem;
      color: rgba(255,255,255,0.9);
      text-shadow: 0 2px 10px rgba(0,0,0,0.8);
      pointer-events: none;
      z-index: 200;
      opacity: 0;
      transform: translateY(20px);
      animation: float-up-fade 4s ease-out forwards;
    }

    @keyframes float-up-fade {
      0% { opacity: 0; transform: translateY(20px); }
      10% { opacity: 1; transform: translateY(0); }
      80% { opacity: 1; transform: translateY(-10px); }
      100% { opacity: 0; transform: translateY(-30px); }
    }

    /* CONTEXT MENU (ELEMENTAL WHEEL) - Simulado */
    .context-menu {
      position: fixed;
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: rgba(10,10,10,0.9);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
      z-index: 500;
      display: none;
      clip-path: circle(50% at 50% 50%);
    }

    .info-panel {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0,0,0,0.5);
        padding: 15px;
        border-radius: 8px;
        color: #aaa;
        font-size: 12px;
        z-index: 1000;
        pointer-events: none;
    }

  </style>
</head>
<body>

  <!-- Mensaje de ayuda -->
  <div class="info-panel">
    <h3>Controles Demo</h3>
    <p>Escribe en la barra inferior (The Quill):</p>
    <ul>
      <li><code>/rain</code> - Lluvia ambiental</li>
      <li><code>/danger</code> - Modo combate/tensión</li>
      <li><code>/calm</code> - Resetear ambiente</li>
      <li><code>/reveal</code> - Revelar mapa completo</li>
      <li><code>Algo se acerca...</code> - Narrativa flotante</li>
    </ul>
    <p>Click en Tokens -> Focus Cámara</p>
    <p>Doble click Mapa -> Reset Cámara</p>
  </div>

  <div class="game-viewport" id="viewport">
    <div class="map-container" id="map">
      <!-- Elementos del mapa -->
      <div class="map-feature room-1"></div>
      <div class="map-feature room-2"></div>
      <div class="map-feature corridor"></div>
      
      <!-- Tokens -->
      <div class="token token-hero" id="hero" onclick="focusCamera(this, event)"></div>
      <div class="token token-enemy" id="enemy" onclick="focusCamera(this, event)"></div>

      <!-- Effects Container -->
      <div id="particles"></div>
      
      <!-- Niebla -->
      <div class="fog-layer" id="fog"></div>
    </div>
  </div>

  <div class="dm-ui">
    <div class="suggestion-pill" id="suggestion">Comando detectado: /rain</div>
    <div class="quill-bar">
      <span style="margin-right: 15px; color: var(--highlight-color);">✦</span>
      <input type="text" class="quill-input" placeholder="Escribe un comando (/rain, /danger) o narra la escena..." id="quill">
    </div>
    <div class="help-text">Presiona ENTER para ejecutar</div>
  </div>

  <script>
    /* ═══════════════════════════════════════
       LOGIC CORE
       ═══════════════════════════════════════ */
    
    const viewport = document.getElementById('viewport');
    const map = document.getElementById('map');
    const quill = document.getElementById('quill');
    const fog = document.getElementById('fog');
    const suggestion = document.getElementById('suggestion');
    const particlesContainer = document.getElementById('particles');

    let currentZoom = 1;
    let particlesInterval = null;

    // --- FOG SYSTEM (SIMPLIFICADO) ---
    const fogState = {
      revealed: [
        { x: 980, y: 980, r: 150 } // Inicio héroe
      ]
    };

    function updateFog() {
      // Generar gradiente mask
      let mask = fogState.revealed.map(p => 
        `radial-gradient(circle ${p.r}px at ${p.x}px ${p.y}px, black 100%, black 100%)`
      ).join(', ');
      
      // Añadir la base transparente para ocultar todo lo demás (composite exclude)
      // Nota: CSS Masking simple: Lo negro se ve, lo transparente no (o viceversa según composite)
      // Usaremos un truco visual para la demo: Background negro con mask holes
      // Mejor aproximación para demo HTML sin canvas complejo:
      
      let gradientList = fogState.revealed.map(p => 
        `radial-gradient(circle ${p.r}px at ${p.x}px ${p.y}px, black 0%, transparent 100%)`
      ).join(', ');

      // En mask-image: black = visible, transparent = hidden
      // Queremos que la capa NIEBLA (negra) sea visible DONDE NO HAY luz
      // Entonces la mascara debe ser BLANCO (visible) - AGUJEROS NEGROS (transparentes)
      // Usando mask-composite: exclude es más fácil.
      
      fog.style.webkitMaskImage = gradientList;
      fog.style.maskImage = gradientList;
    }
    
    // updateFog(); // Init

    // Update fog - Hack visual para la demo
    // Simplemente haremos agujeros en la capa negra
    fog.style.background = 'radial-gradient(circle at 50% 50%, transparent 100px, #080808 150px)';
    
    function revealArea(x, y, r) {
      // Para la demo, simplemente movemos el "agujero" principal del background
      // En producción esto usaría canvas o mask-composite múltiple
      fog.style.background = `radial-gradient(circle at ${x}px ${y}px, transparent ${r}px, #080808 ${r+50}px)`;
    }
    revealArea(980, 980, 200);


    // --- CAMERA SYSTEM ---
    function focusCamera(element, e) {
      e.stopPropagation();
      const rect = element.getBoundingClientRect(); // Posición en pantalla
      const mapRect = map.getBoundingClientRect(); // Posición mapa
      
      // Calcular posición del elemento RELATIVA al mapa original (sin escalas)
      // Left offset: (rect.left - mapRect.left) / scale
      const scale = currentZoom; // Aproximado
      
      // Simplificado: Leer coordenadas CSS left/top
      const style = window.getComputedStyle(element);
      const x = parseInt(style.left);
      const y = parseInt(style.top);

      moveTo(x, y, 2);
    }

    function moveTo(x, y, zoom) {
      currentZoom = zoom;
      // Centrar viewport (1000, 1000 es el centro del mapa container)
      // Queremos que el punto (x,y) esté en el centro de la pantalla
      // Map center is at 50% 50% of viewport initially.
      
      // Transform logic: translate is from origin center.
      // Origin is center.
      // Point (x,y) relative to top-left (0,0) of map.
      // Center of map is (1000, 1000).
      // Delta from center: dx = x - 1000, dy = y - 1000.
      const dx = x - 1000;
      const dy = y - 1000;

      map.style.transform = `translate(${-dx}px, ${-dy}px) scale(${zoom})`;
    }

    document.getElementById('viewport').addEventListener('dblclick', () => {
      moveTo(1000, 1000, 1); // Reset
    });


    // --- PARTICLE SYSTEM ---
    function spawnParticles(type) {
      if (particlesInterval) clearInterval(particlesInterval);
      particlesContainer.innerHTML = ''; // Clear

      if (type === 'rain') {
        particlesInterval = setInterval(() => {
          const p = document.createElement('div');
          p.className = 'particle';
          p.style.left = Math.random() * 100 + 'vw';
          p.style.width = '2px';
          p.style.height = '15px';
          p.style.background = 'rgba(150, 180, 255, 0.5)';
          p.style.animation = `rain-drop ${0.5 + Math.random()}s linear`;
          particlesContainer.appendChild(p);
          
          setTimeout(() => p.remove(), 1000);
        }, 10); // Alta densidad
      }
    }
    
    function clearParticles() {
      if (particlesInterval) clearInterval(particlesInterval);
      particlesContainer.innerHTML = '';
    }


    // --- THE QUILL (COMMAND CENTER) ---
    quill.addEventListener('input', (e) => {
      const val = e.target.value;
      if (val.startsWith('/')) {
        suggestion.textContent = `Comando detectado: ${val.split(' ')[0]}`;
        suggestion.classList.add('visible');
      } else {
        suggestion.classList.remove('visible');
      }
    });

    quill.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        processCommand(quill.value);
        quill.value = '';
        suggestion.classList.remove('visible');
      }
    });

    function processCommand(text) {
      // Comandos
      if (text.startsWith('/rain')) {
        spawnParticles('rain');
        showNarrative('Comienza a llover...');
        document.body.setAttribute('data-mood', 'cold');
      } else if (text.startsWith('/danger')) {
        document.body.setAttribute('data-mood', 'danger');
        showNarrative('¡PELIGRO INMINENTE!');
      } else if (text.startsWith('/calm')) {
        document.body.setAttribute('data-mood', '');
        clearParticles();
        showNarrative('La calma regresa.');
      } else if (text.startsWith('/reveal')) {
        fog.style.opacity = '0';
        showNarrative('El mapa se revela.');
      } else {
        // Narrativa normal
        showNarrative(text);
      }
    }

    function showNarrative(text) {
      const el = document.createElement('div');
      el.className = 'narrative-float';
      el.textContent = text;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 4000);
    }

  </script>
</body>
</html>
