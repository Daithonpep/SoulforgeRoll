<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Soulforge: The Living Chronicle (V5 - Integrated)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500&display=swap');

        :root {
            --bg-void: #050505;
            --gold-accent: #c9a959;
            --gold-dim: #6d5c32;
            --soul-blue: #a3c4db;
            --blood-red: #8a1c1c;
            --glass-bg: rgba(10, 12, 16, 0.85);
            --border-light: rgba(255, 255, 255, 0.05);
            --ease-cinematic: cubic-bezier(0.22, 1, 0.36, 1);
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-void);
            font-family: 'Cormorant Garamond', serif;
            color: #e0e0e0;
            user-select: none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LAYER 0: WORLD RENDER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #world-canvas,
        #fog-canvas {
            position: absolute;
            inset: 0;
            z-index: 1;
            transition: opacity 2s ease;
        }

        #fog-canvas {
            z-index: 2;
            mix-blend-mode: multiply;
            pointer-events: none;
        }

        #map-tokens-layer {
            position: absolute;
            inset: 0;
            z-index: 10;
            pointer-events: none;
        }

        .map-token,
        .narrative-anchor {
            pointer-events: auto;
        }

        /* RECOVERED V2 EFFECTS: PARTICLES & ANIMATIONS */
        .particle-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 20;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            background: var(--gold-accent);
            box-shadow: 0 0 10px var(--gold-accent);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LAYER 1: LOBBY (The Void)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* CSS PATCH FOR LOBBY INTERACTIVITY */
        #lobby-container {
            position: absolute;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Allow clicks to pass through empty space */
            pointer-events: none;
            transition: transform 1.5s var(--ease-cinematic), opacity 1s ease;
        }

        /* Enable pointers on interactive elements */
        .void-core,
        .soul-card,
        .gold-button {
            pointer-events: auto;
        }

        .void-core {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            border: 1px dashed rgba(255, 255, 255, 0.1);
            background: radial-gradient(circle, rgba(10, 10, 15, 1) 0%, rgba(0, 0, 0, 0) 70%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            cursor: pointer;
            transition: all 0.5s ease;
        }

        .void-core:hover {
            border-color: var(--gold-accent);
            box-shadow: 0 0 50px rgba(201, 169, 89, 0.1);
        }

        .void-text {
            font-family: 'Cinzel';
            color: #444;
            letter-spacing: 2px;
            text-align: center;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .void-core:hover .void-text {
            color: var(--gold-accent);
        }

        .soul-orbit {
            position: absolute;
            width: 500px;
            height: 500px;
            /* Reduced size */
            animation: slowRotate 120s linear infinite;
            pointer-events: none;
        }

        @keyframes slowRotate {
            to {
                transform: rotate(360deg);
            }
        }

        .soul-card {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #111;
            border: 2px solid #333;
            cursor: pointer;
            pointer-events: auto;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .soul-card:hover {
            border-color: var(--gold-accent);
            transform: scale(1.2);
            z-index: 100;
        }

        .soul-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-size: cover;
        }

        /* Lobby HUD */
        .echo-teaser {
            position: absolute;
            bottom: 140px;
            width: 100%;
            text-align: center;
            font-family: 'Cinzel';
            font-size: 1.2rem;
            color: #888;
            letter-spacing: 4px;
            z-index: 60;
        }

        .gold-button {
            position: absolute;
            bottom: 80px;
            right: 80px;
            background: rgba(0, 0, 0, 0.8);
            /* Better visibility */
            border: 2px solid #555;
            color: #777;
            padding: 15px 40px;
            font-family: 'Cinzel';
            cursor: not-allowed;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 200;
            /* Super high Z */
        }

        .gold-button.ready {
            border-color: var(--gold-accent);
            color: var(--gold-accent);
            cursor: pointer;
            background: rgba(10, 10, 10, 0.9);
            box-shadow: 0 0 30px rgba(201, 169, 89, 0.15);
        }

        .gold-button.ready:hover {
            transform: scale(1.05);
            background: rgba(201, 169, 89, 0.1);
            box-shadow: 0 0 50px rgba(201, 169, 89, 0.3);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LAYER 2: GAME UI (OMNI-COCKPIT)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #game-ui {
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity 1s ease 1s;
            z-index: 200;
        }

        #game-ui.active {
            opacity: 1;
        }

        /* 1. The Quill (Command Bar) */
        .the-quill {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            border: 1px solid var(--border-light);
            backdrop-filter: blur(12px);
            padding: 12px 25px;
            border-radius: 100px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 500px;
            pointer-events: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease;
        }

        .the-quill:focus-within {
            transform: translateX(-50%) translateY(-5px);
            border-color: var(--gold-accent);
        }

        .quill-input {
            background: transparent;
            border: none;
            color: white;
            width: 100%;
            outline: none;
            font-family: 'Cinzel';
            font-size: 1rem;
        }

        /* 2. Side Panels */
        .panel {
            position: absolute;
            top: 40px;
            bottom: 100px;
            width: 300px;
            background: var(--glass-bg);
            border: 1px solid var(--border-light);
            backdrop-filter: blur(10px);
            padding: 20px;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: transform 0.5s var(--ease-cinematic);
        }

        .panel-left {
            left: 0;
            border-radius: 0 12px 12px 0;
            border-left: none;
            transform: translateX(-320px);
        }

        .panel-right {
            right: 0;
            border-radius: 12px 0 0 12px;
            border-right: none;
            transform: translateX(320px);
        }

        #game-ui.active .panel-left,
        #game-ui.active .panel-right {
            transform: translateX(0);
        }

        /* Headers */
        .panel-header {
            font-family: 'Cinzel';
            color: var(--gold-accent);
            font-size: 1.1rem;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 3. Entity Monitor (Left) */
        .entity-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid transparent;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.2s;
        }

        .entity-card:hover {
            border-color: var(--gold-dim);
            background: rgba(201, 169, 89, 0.05);
        }

        .entity-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-size: cover;
            border: 1px solid #555;
        }

        .entity-info {
            flex: 1;
        }

        .entity-name {
            font-family: 'Inter';
            font-weight: 500;
            font-size: 0.9rem;
            color: #ddd;
        }

        .entity-status {
            font-size: 0.75rem;
            color: #888;
        }

        /* 4. Chronicle Log (Right) */
        #log-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-family: 'Inter';
            font-size: 0.9rem;
            scrollbar-width: thin;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            line-height: 1.4;
        }

        .log-entry.system {
            color: #888;
            font-style: italic;
            font-size: 0.8rem;
        }

        .log-entry.narrative {
            color: #ccc;
            border-left: 2px solid var(--gold-dim);
            padding-left: 10px;
        }

        .log-entry.voice {
            color: var(--soul-blue);
            font-style: italic;
        }

        /* 5. DM Tools */
        .dm-toolbar {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }

        .tool-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #555;
            background: #111;
            color: #888;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .tool-btn:hover,
        .tool-btn.active {
            border-color: var(--gold-accent);
            color: var(--gold-accent);
        }

        /* RECOVERED V2: SPEECH BUBBLES & TOKEN ANIMATION */
        .map-token {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--gold-accent);
            background-size: cover;
            cursor: grab;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 100;
            transition: transform 0.2s ease;
        }

        .map-token:active {
            cursor: grabbing;
            transform: scale(0.9);
        }

        .map-token.speaking {
            animation: shakeToken 0.2s infinite;
            border-color: white;
            box-shadow: 0 0 30px white;
        }

        @keyframes shakeToken {
            0% {
                transform: translate(1px, 1px) rotate(0deg);
            }

            10% {
                transform: translate(-1px, -2px) rotate(-1deg);
            }

            20% {
                transform: translate(-3px, 0px) rotate(1deg);
            }

            30% {
                transform: translate(3px, 2px) rotate(0deg);
            }

            40% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            50% {
                transform: translate(-1px, 2px) rotate(-1deg);
            }

            60% {
                transform: translate(-3px, 1px) rotate(0deg);
            }

            70% {
                transform: translate(3px, 1px) rotate(-1deg);
            }

            80% {
                transform: translate(-1px, -1px) rotate(1deg);
            }

            90% {
                transform: translate(1px, 2px) rotate(0deg);
            }

            100% {
                transform: translate(1px, -2px) rotate(-1deg);
            }
        }

        .speech-bubble {
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: rgba(255, 255, 255, 0.95);
            color: #111;
            padding: 10px 20px;
            border-radius: 20px;
            font-family: 'Inter';
            font-size: 0.9rem;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s var(--ease-cinematic);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            min-width: 100px;
        }

        .speech-bubble.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }

        .narrative-anchor {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--gold-accent);
            border-radius: 50%;
            cursor: help;
            box-shadow: 0 0 10px var(--gold-accent);
        }

        .narrative-anchor:hover::before {
            content: attr(data-hint);
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: #111;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #444;
            white-space: nowrap;
            color: #eee;
            font-family: 'Inter';
            font-size: 0.8rem;
            z-index: 200;
        }
    </style>
</head>

<body>

    <!-- LAYER 0: THE WORLD -->
    <canvas id="world-canvas"></canvas>
    <div id="map-tokens-layer"></div>
    <div class="particle-layer" id="particles"></div>
    <canvas id="fog-canvas"></canvas>

    <!-- LAYER 1: LOBBY -->
    <div id="lobby-container">
        <div class="soul-orbit" id="orbit"></div>
        <div class="void-core" id="drop-zone">
            <div style="font-size: 2rem; color: #333;">âœ¦</div>
            <div class="void-text">FORJA COLECTIVA<br><span style="font-size: 0.7em;">Arrastra JSONs</span></div>
            <input type="file" id="file-input" multiple accept=".json" style="display: none;">
        </div>

        <div class="echo-teaser" id="echo-text">El vacÃ­o espera...</div>
        <!-- Moved button out slightly to visual safe zone -->
        <button class="gold-button" id="start-btn" onclick="Director.startGame()">
            <span>INICIAR CRÃ“NICA</span>
        </button>
    </div>

    <!-- LAYER 2: INTERFACE -->
    <div id="game-ui">
        <!-- Toolbar -->
        <div class="dm-toolbar">
            <div class="tool-btn" title="Toggle Fog" onclick="Fog.toggle()">ğŸ‘ï¸</div>
            <div class="tool-btn" title="Weather" onclick="Atmosphere.rain()">ğŸŒ§ï¸</div>
        </div>

        <!-- Left Panel -->
        <div class="panel panel-left">
            <div class="panel-header"><span>DRAMATIS PERSONAE</span><span>ğŸ‘¥</span></div>
            <div id="minis-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>

        <!-- Right Panel - LOG -->
        <div class="panel panel-right">
            <div class="panel-header"><span>LA CRÃ“NICA</span><span>ğŸ“œ</span></div>
            <div id="log-container">
                <div class="log-entry system">Sistema iniciado. Esperando destino...</div>
            </div>
        </div>

        <!-- Quill -->
        <div class="the-quill">
            <span style="color: var(--gold-accent);">âœ</span>
            <input type="text" class="quill-input" placeholder="Comandos: /voice [msg], /roll, /rain" id="cmd-input">
        </div>
    </div>

    <script>
        /**
         * SOULFORGE V5.1 (FIXED): STABILITY PATCH
         * Fixes initialization, button events, and safety checks.
         */

        /* --- CARTOGRAPHER (Unchanged Logic) --- */
        const Cartographer = {
            ctx: null, width: 0, height: 0,
            mood: 'NEUTRAL',

            init(id) { const c = document.getElementById(id); this.ctx = c.getContext('2d'); this.resize(); window.addEventListener('resize', () => this.resize()); },
            resize() { this.width = window.innerWidth; this.height = window.innerHeight; this.ctx.canvas.width = this.width; this.ctx.canvas.height = this.height; },
            setMood(m) { this.mood = m; },
            generate() {
                const ctx = this.ctx;
                let bgColor = '#e3d8c4';
                if (this.mood === 'DARK') bgColor = '#2a2222';
                if (this.mood === 'HEROIC') bgColor = '#e8f4f8';
                ctx.fillStyle = bgColor; ctx.fillRect(0, 0, this.width, this.height);

                // Noise
                const idata = ctx.getImageData(0, 0, this.width, this.height);
                for (let i = 0; i < idata.data.length; i += 4) {
                    const n = Math.random() * 20 - 10;
                    idata.data[i] += n; idata.data[i + 1] += n; idata.data[i + 2] += n;
                }
                ctx.putImageData(idata, 0, 0);

                this.drawRivers(3);
                this.drawMountains(6);
                this.drawForests(10);
                this.drawTowns(4);
            },
            drawRivers(n) { const ctx = this.ctx; ctx.strokeStyle = 'rgba(74, 107, 140, 0.6)'; ctx.lineWidth = 3; for (let i = 0; i < n; i++) { let x = Math.random() * this.width, y = 0; ctx.beginPath(); ctx.moveTo(x, y); for (let j = 0; j < 20; j++) { x += (Math.random() - 0.5) * 100; y += this.height / 20; ctx.lineTo(x, y); } ctx.stroke(); } },
            drawMountains(n) { const ctx = this.ctx; ctx.strokeStyle = '#2b2319'; ctx.lineWidth = 2; for (let i = 0; i < n; i++) { const cx = Math.random() * this.width, cy = Math.random() * this.height; for (let j = 0; j < 15; j++) { const mx = cx + (Math.random() - 0.5) * 150, my = cy + (Math.random() - 0.5) * 80; ctx.beginPath(); ctx.moveTo(mx - 10, my + 10); ctx.lineTo(mx, my - 10); ctx.lineTo(mx + 10, my + 10); ctx.stroke(); } } },
            drawForests(n) { const ctx = this.ctx; ctx.fillStyle = '#1e261f'; for (let i = 0; i < n; i++) { const cx = Math.random() * this.width, cy = Math.random() * this.height; for (let j = 0; j < 30; j++) { const fx = cx + (Math.random() - 0.5) * 120, fy = cy + (Math.random() - 0.5) * 120; ctx.beginPath(); ctx.moveTo(fx, fy - 10); ctx.lineTo(fx + 4, fy); ctx.lineTo(fx - 4, fy); ctx.fill(); } } },
            drawTowns(n) { const ctx = this.ctx; ctx.fillStyle = '#8a1c1c'; ctx.font = '16px Cinzel'; ctx.textAlign = 'center'; const t = ["Roble Viejo", "Aguasnegras", "Pico Tormenta", "Valle Dorado"]; for (let i = 0; i < n; i++) { const tx = Math.random() * this.width, ty = Math.random() * this.height; ctx.fillRect(tx - 5, ty - 5, 10, 10); ctx.fillText(t[i] || "Ruinas", tx, ty + 20); } }
        };

        /* --- PARTICLES --- */
        const Particles = {
            spawn(x, y, type = 'gold') {
                const el = document.createElement('div'); el.className = 'particle';
                const layer = document.getElementById('particles');
                const size = Math.random() * 5 + 2;
                el.style.width = size + 'px'; el.style.height = size + 'px';
                el.style.left = x + 'px'; el.style.top = y + 'px';
                layer.appendChild(el);
                const destX = (Math.random() - 0.5) * 100;
                const destY = (Math.random() - 0.5) * 100 - 50;
                const anim = el.animate([{ transform: 'translate(0,0)', opacity: 1 }, { transform: `translate(${destX}px, ${destY}px)`, opacity: 0 }], { duration: 1000, easing: 'ease-out' });
                anim.onfinish = () => el.remove();
            }
        };

        /* --- LOBBY & DIRECTOR --- */
        const Lobby = {
            souls: [],
            addSoul(json) {
                if (!json || !json.identidad) return console.error('Invalid JSON');
                if (this.souls.find(s => s.id === json.id)) return;

                this.souls.push(json);
                this.render();

                // Unlock Button
                const btn = document.getElementById('start-btn');
                btn.classList.add('ready');
                btn.querySelector('span').innerText = `INICIAR CRÃ“NICA (${this.souls.length})`;

                // Safe Mood Check
                try {
                    const tones = json.biografia.fases.map(f => f.tonalidad);
                    if (tones.includes('Sombrio')) Cartographer.setMood('DARK');
                } catch (e) { console.warn("Mood check skipped", e); }
            },
            render() {
                const orb = document.getElementById('orbit'); orb.innerHTML = '';
                const step = 360 / this.souls.length;
                this.souls.forEach((s, i) => {
                    const el = document.createElement('div'); el.className = 'soul-card';
                    el.innerHTML = `<div class="soul-img" style="background-image:url('https://api.dicebear.com/7.x/avataaars/svg?seed=${s.identidad.nombre}')"></div>`;

                    // Orbit Math (Radius 250 for 500px container)
                    const a = (i * step) * (Math.PI / 180);
                    const radius = 250;
                    const centerX = 250; const centerY = 250; // Half of 500px w/h

                    // Center element (30px offset for 60px width)
                    el.style.left = (centerX + Math.cos(a) * radius - 30) + 'px';
                    el.style.top = (centerY + Math.sin(a) * radius - 30) + 'px';
                    orb.appendChild(el);
                });

                // Update Teaser
                const names = this.souls.map(s => s.rol).join(" + ");
                document.getElementById('echo-text').innerText = `${names}... EL DESTINO AGUARDA.`;
            }
        };

        const Director = {
            init() {
                Cartographer.init('world-canvas'); Fog.init();
                const inp = document.getElementById('cmd-input');
                inp.addEventListener('keypress', e => { if (e.key === 'Enter') this.processCommand(e.target.value); });

                // UI Binds
                const dz = document.getElementById('drop-zone');
                const fi = document.getElementById('file-input');

                dz.onclick = () => fi.click();
                dz.ondragover = e => e.preventDefault();
                dz.ondrop = e => {
                    e.preventDefault();
                    Array.from(e.dataTransfer.files).forEach(f => this.readFile(f));
                };
                fi.onchange = e => Array.from(e.target.files).forEach(f => this.readFile(f));
            },

            readFile(file) {
                const r = new FileReader();
                r.onload = ev => {
                    try {
                        Lobby.addSoul(JSON.parse(ev.target.result));
                    } catch (e) {
                        alert("Error al leer archivo: " + e.message);
                    }
                };
                r.readAsText(file);
            },

            startGame() {
                if (!Lobby.souls.length) {
                    alert("Â¡Debes invocar al menos un alma (JSON) antes de iniciar!");
                    return;
                }

                const lobby = document.getElementById('lobby-container');
                lobby.style.transform = "scale(2)"; // Cinematic Zoom
                lobby.style.opacity = 0;

                setTimeout(() => {
                    lobby.style.display = 'none';
                    document.getElementById('game-ui').classList.add('active');

                    Cartographer.generate();
                    Lobby.souls.forEach((s) => this.spawnToken(s));
                    Fog.clear(window.innerWidth / 2, window.innerHeight / 2, 300);

                    this.log('Sistema de CrÃ³nica Activo.', 'system');
                }, 1200);
            },

            spawnToken(soul) {
                const t = document.createElement('div'); t.className = 'map-token'; t.id = `token-${soul.identidad.nombre}`;
                t.style.backgroundImage = `url('https://api.dicebear.com/7.x/avataaars/svg?seed=${soul.identidad.nombre}')`;
                t.innerHTML = `<div class="speech-bubble" id="bubble-${soul.identidad.nombre}"></div>`;

                t.style.left = (window.innerWidth / 2 + (Math.random() - 0.5) * 100) + 'px';
                t.style.top = (window.innerHeight / 2 + (Math.random() - 0.5) * 100) + 'px';

                let drag = false;
                t.onmousedown = () => drag = true;
                window.onmouseup = () => drag = false;
                window.onmousemove = e => {
                    if (drag) {
                        t.style.left = (e.clientX - 30) + 'px'; t.style.top = (e.clientY - 30) + 'px';
                        Fog.clear(e.clientX, e.clientY, 80);
                        if (Math.random() > 0.8) Particles.spawn(e.clientX, e.clientY);
                    }
                };
                document.getElementById('map-tokens-layer').appendChild(t);
                this.addSidebar(soul);
            },

            addSidebar(s) {
                const el = document.createElement('div'); el.className = 'entity-card';
                el.innerHTML = `
            <div class="entity-avatar" style="background-image:url('https://api.dicebear.com/7.x/avataaars/svg?seed=${s.identidad.nombre}')"></div>
            <div class="entity-info"><div class="entity-name">${s.identidad.nombre}</div><div class="entity-status">${s.rol}</div></div>`;
                document.getElementById('minis-list').appendChild(el);
            },

            processCommand(txt) {
                document.getElementById('cmd-input').value = '';
                if (txt.startsWith('/voice ') || txt.startsWith('/say ')) {
                    const msg = txt.split(' ').slice(1).join(' ');
                    if (Lobby.souls.length > 0) this.voiceAct(Lobby.souls[0].identidad.nombre, msg);
                } else if (txt === '/roll') {
                    this.log(`ğŸ² ${Math.floor(Math.random() * 20) + 1}`, 'system');
                } else {
                    this.log(txt, 'narrative');
                }
            },

            voiceAct(name, text) {
                const t = document.getElementById(`token-${name}`);
                const b = document.getElementById(`bubble-${name}`);
                if (t && b) {
                    t.classList.add('speaking'); b.innerText = text; b.classList.add('visible');
                    Particles.spawn(t.offsetLeft + 30, t.offsetTop, 'voice');
                    this.log(`${name}: "${text}"`, 'voice');
                    setTimeout(() => { t.classList.remove('speaking'); b.classList.remove('visible'); }, 3000);
                }
            },
            log(m, t) { const c = document.getElementById('log-container'); const d = document.createElement('div'); d.className = `log-entry ${t}`; d.innerText = m; c.appendChild(d); c.scrollTop = c.scrollHeight; }
        };

        /* --- FOG --- */
        const Fog = {
            ctx: null,
            init() { const c = document.getElementById('fog-canvas'); this.ctx = c.getContext('2d'); c.width = window.innerWidth; c.height = window.innerHeight; this.fill(); },
            fill() { this.ctx.fillStyle = 'black'; this.ctx.fillRect(0, 0, window.innerWidth, window.innerHeight); },
            clear(x, y, r) { const c = this.ctx; c.globalCompositeOperation = 'destination-out'; c.beginPath(); c.arc(x, y, r, 0, Math.PI * 2); c.fill(); for (let i = 0; i < 5; i++) { c.beginPath(); c.arc(x + (Math.random() - 0.5) * r, y + (Math.random() - 0.5) * r, r * 0.3, 0, Math.PI * 2); c.fill(); } c.globalCompositeOperation = 'source-over'; },
            toggle() { const c = document.getElementById('fog-canvas'); c.style.opacity = c.style.opacity === '0' ? '1' : '0'; }
        };

        Director.init();
    </script>
</body>

</html>