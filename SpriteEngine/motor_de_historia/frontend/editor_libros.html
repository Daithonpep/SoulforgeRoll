<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulForge Writer - La Fragua de Historias</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;900&family=EB+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">

    <!-- Firebase SDK (v9 compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // CONFIGURACIÓN DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyD7hlbOrBZ5ZtxVw0cPxoBJ0zchrbIG_iA",
            authDomain: "soulforge-46225.firebaseapp.com",
            projectId: "soulforge-46225",
            storageBucket: "soulforge-46225.firebasestorage.app",
            messagingSenderId: "170327957641",
            appId: "1:170327957641:web:f084dc67c2eaa619f4e658",
            measurementId: "G-4KQLFKZ2BK"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>
    <style>
        :root {
            --bg-void: #050508;
            --bg-dark: #0a0a0f;
            --panel-dark: #0d0d12;
            --panel-mid: #131318;
            --panel-lighter: #1a1a22;
            --border-subtle: #222228;
            --border-gold: rgba(197, 160, 89, 0.3);

            --paper: #f4efe4;
            --paper-dark: #e8e0d0;
            --ink: #2a2520;
            --ink-light: #5a5550;

            --gold: #c5a059;
            --gold-bright: #e8c873;
            --gold-dim: #8a7040;
            --blood: #8a1515;
            --blood-glow: #c02020;
            --emerald: #2d8a5a;
            --amethyst: #7a5af0;

            --text-primary: #e8e6e0;
            --text-secondary: #a0a0a0;
            --text-dim: #606060;

            --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.8);
            --shadow-glow-gold: 0 0 30px rgba(197, 160, 89, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg-void);
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ========== HEADER ========== */
        .forge-header {
            height: 56px;
            /* Wood Texture */
            background-color: #1a110a;
            background-image:
                linear-gradient(180deg, rgba(30, 20, 10, 0.9) 0%, rgba(10, 5, 0, 0.95) 100%),
                repeating-linear-gradient(90deg, transparent 0px, transparent 3px, rgba(0, 0, 0, 0.3) 4px, transparent 5px),
                repeating-linear-gradient(45deg, rgba(40, 25, 15, 0.3) 0px, rgba(40, 25, 15, 0.3) 30px, rgba(20, 12, 5, 0.4) 60px);
            border-bottom: 3px solid #2a1a10;
            box-shadow: inset 0 -2px 4px rgba(0, 0, 0, 0.5), 0 2px 8px rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            position: relative;
            z-index: 100;
        }

        /* Leather Binding Strip on Header Bottom */
        .forge-header::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 0;
            right: 0;
            height: 6px;
            /* Dark leather strip with embossed gold stitching */
            background:
                /* Cross-stitch pattern */
                repeating-linear-gradient(90deg,
                    transparent 0px, transparent 4px,
                    #8a7040 5px, #c5a059 6px, #8a7040 7px,
                    transparent 8px, transparent 16px),
                /* Second row offset for X pattern */
                repeating-linear-gradient(90deg,
                    transparent 8px, transparent 12px,
                    #6a5030 13px, #8a7040 14px, #6a5030 15px,
                    transparent 16px, transparent 24px),
                /* Leather backing */
                linear-gradient(180deg, #2a1a10 0%, #1a0a05 100%);
            border-top: 1px solid #4a3020;
            border-bottom: 1px solid #0a0505;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Decorative Metal Corner Studs */
        .forge-header::before {
            content: '◆ ─────────';
            position: absolute;
            left: 8px;
            bottom: -6px;
            color: var(--gold);
            font-size: 0.5rem;
            letter-spacing: -1px;
            text-shadow: 0 0 3px var(--gold-dim), 0 1px 1px rgba(0, 0, 0, 0.9);
            opacity: 0.6;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dim) 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(197, 160, 89, 0.3);
        }

        .brand-text {
            font-family: 'Cinzel', serif;
            font-weight: 600;
            font-size: 1.1rem;
            letter-spacing: 3px;
            color: var(--text-primary);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .btn-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 4px;
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            /* Leather Button Style */
            background: linear-gradient(180deg, #3d2817 0%, #2a1a10 50%, #1a0f08 100%);
            border: 2px solid #4a3020;
            border-top-color: #5a4030;
            border-bottom-color: #1a0a05;
            color: var(--gold);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.3),
                0 2px 4px rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
        }

        .btn-header:hover {
            background: linear-gradient(180deg, #4a3020 0%, #3d2817 50%, #2a1a10 100%);
            border-color: var(--gold-dim);
            color: var(--gold-bright);
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.15),
                0 0 10px rgba(197, 160, 89, 0.3),
                0 3px 6px rgba(0, 0, 0, 0.4);
        }

        .btn-header.primary {
            background: linear-gradient(180deg, var(--gold-bright) 0%, var(--gold) 50%, var(--gold-dim) 100%);
            border: 2px solid var(--gold-bright);
            border-top-color: #ffe0a0;
            border-bottom-color: #6a5030;
            color: #1a0a05;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.3);
            font-weight: 700;
        }

        .btn-header.primary:hover {
            box-shadow:
                0 0 15px rgba(197, 160, 89, 0.6),
                0 4px 8px rgba(0, 0, 0, 0.4);
            transform: translateY(-1px);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            /* Leather pill style */
            background: linear-gradient(180deg, #3d2817 0%, #2a1a10 100%);
            border: 2px solid #4a3020;
            border-radius: 20px;
            font-size: 0.75rem;
            font-family: 'Cinzel', serif;
            color: var(--gold);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--text-dim);
            border-radius: 50%;
            transition: all 0.3s;
        }

        .status-dot.active {
            background: var(--emerald);
            box-shadow: 0 0 8px var(--emerald);
            animation: pulse-status 2s infinite;
        }

        @keyframes pulse-status {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        /* ========== WORKSPACE ========== */
        .workspace {
            display: grid;
            grid-template-columns: 260px 1fr 300px;
            height: calc(100vh - 56px);

            /* REALISTIC ANCIENT WOOD SHADER */
            background-color: #2e1d13;
            background-image:
                /* Deep Varnish Vignette */
                radial-gradient(circle at center, transparent 0%, rgba(0, 0, 0, 0.8) 120%),
                /* Wood Fibers - subtle horizontal scratches */
                repeating-linear-gradient(92deg, transparent 0px, transparent 2px, rgba(0, 0, 0, 0.2) 3px, transparent 4px),
                /* Large Grain - diagonal banding */
                repeating-linear-gradient(45deg, rgba(62, 39, 35, 0.4) 0px, rgba(62, 39, 35, 0.4) 40px, rgba(42, 28, 20, 0.6) 80px),
                /* Base Wood Color */
                linear-gradient(to bottom, #3e2723, #1a0f0a);

            box-shadow: inset 0 0 150px rgba(0, 0, 0, 0.95);
            /* Deep shadow */
            position: relative;
            overflow: hidden;
        }

        /* NOISE TEXTURE FOR GRAIN REALISM */
        .workspace::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* SVG Noise Data URI */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.5'/%3E%3C/svg%3E");
            opacity: 0.08;
            /* Subtle grit */
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        /* FIRE GLOW EFFECT - ORGANIC CANDLE */
        .fire-layer {
            position: fixed;
            bottom: -50px;
            left: 0;
            right: 0;
            pointer-events: none;
            mix-blend-mode: screen;
            z-index: 5;
            transition: opacity 1s;
        }

        /* Base Warmth (Stable) */
        #fire-glow-base {
            height: 45vh;
            background: radial-gradient(ellipse at center bottom, rgba(255, 100, 0, 0.3) 0%, rgba(139, 0, 0, 0.1) 60%, transparent 80%);
            filter: blur(40px);
            opacity: 0.6;
        }

        /* Flickering Heart (Erratic) */
        #fire-glow-flicker {
            height: 55vh;
            background: radial-gradient(circle at 50% 100%, rgba(255, 200, 50, 0.25) 0%, rgba(255, 69, 0, 0.15) 50%, transparent 80%);
            filter: blur(60px);
            animation: candle-flicker 3s infinite alternate-reverse cubic-bezier(0.5, 0, 0.5, 1);
            opacity: 0.7;
        }

        @keyframes candle-flicker {
            0% {
                transform: scale(1.0) translateX(0px);
                opacity: 0.6;
            }

            10% {
                transform: scale(1.02) translateX(5px);
                opacity: 0.65;
            }

            20% {
                transform: scale(0.98) translateX(-5px);
                opacity: 0.6;
            }

            40% {
                transform: scale(1.05) translateX(8px);
                opacity: 0.7;
            }

            60% {
                transform: scale(1.0) translateX(-3px);
                opacity: 0.6;
            }

            80% {
                transform: scale(1.03) translateX(4px);
                opacity: 0.65;
            }

            100% {
                transform: scale(0.99) translateX(0px);
                opacity: 0.6;
            }
        }

        .glow-chaos {
            filter: blur(20px) !important;
            opacity: 1 !important;
            background: radial-gradient(ellipse at center bottom, rgba(255, 255, 255, 0.5) 0%, rgba(255, 100, 0, 0.8) 50%, transparent 100%) !important;
            transition: all 0.1s !important;
        }

        /* AMBIENCE CONTROLS */
        .ambience-dock {
            position: fixed;
            bottom: 25px;
            left: 30px;
            /* Far left to clear the writing area */
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            padding: 8px 12px;
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .btn-ambience {
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 1.2rem;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-ambience:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-ambience.active {
            color: var(--gold-bright);
            background: rgba(197, 160, 89, 0.2);
            box-shadow: 0 0 10px var(--gold-dim);
        }

        /* VOLUME SLIDER (Hidden by default) */
        .volume-slider {
            width: 0;
            overflow: hidden;
            transition: width 0.3s;
            display: flex;
            align-items: center;
        }

        .ambience-dock:hover .volume-slider {
            width: 60px;
            margin-left: 10px;
        }

        /* ========== LEFT PANEL: SOULS ========== */
        .panel-souls {
            /* Leather Texture Base */
            background-color: #1a1210;
            background-image:
                radial-gradient(ellipse at 30% 30%, rgba(60, 40, 25, 0.3) 0%, transparent 50%),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.15'/%3E%3C/svg%3E");
            border-right: 4px solid #3d2817;
            box-shadow: inset -3px 0 8px rgba(0, 0, 0, 0.5), 2px 0 4px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Leather Binding Strip on Right Edge */
        .panel-souls::after {
            content: '';
            position: absolute;
            right: -1px;
            top: 0;
            bottom: 0;
            width: 8px;
            /* Vertical leather binding with cross-stitch */
            background:
                repeating-linear-gradient(180deg,
                    transparent 0px, transparent 4px,
                    #8a7040 5px, #c5a059 6px, #8a7040 7px,
                    transparent 8px, transparent 14px),
                repeating-linear-gradient(180deg,
                    transparent 7px, transparent 11px,
                    #6a5030 12px, #8a7040 13px, #6a5030 14px,
                    transparent 15px, transparent 21px),
                linear-gradient(90deg, #2a1a10 0%, #1a0a05 100%);
            border-left: 1px solid #4a3020;
            border-right: 1px solid #0a0505;
            pointer-events: none;
        }

        /* Decorative Corner Rivet */
        .panel-souls::before {
            content: '◆';
            position: absolute;
            right: 2px;
            top: 6px;
            color: var(--gold);
            font-size: 0.6rem;
            text-shadow: 0 0 4px var(--gold-dim), 0 1px 2px rgba(0, 0, 0, 0.9);
            z-index: 10;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .panel-header h3 {
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--gold);
            letter-spacing: 2px;
            margin-bottom: 4px;
        }

        .panel-header span {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .soul-drop-zone {
            margin: 16px;
            padding: 32px 16px;
            border: 2px dashed var(--border-subtle);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0, 0, 0, 0.2);
        }

        .soul-drop-zone:hover,
        .soul-drop-zone.dragover {
            border-color: var(--gold);
            background: rgba(197, 160, 89, 0.05);
        }

        .drop-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            opacity: 0.4;
        }

        .soul-drop-zone.dragover .drop-icon {
            opacity: 1;
            animation: bounce 0.5s ease infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .drop-text {
            font-size: 0.75rem;
            color: var(--text-dim);
            line-height: 1.4;
        }

        .soul-list {
            flex: 1;
            padding: 0 16px 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .soul-card {
            background: var(--panel-lighter);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
            position: relative;
        }

        .soul-card:hover {
            border-color: var(--gold);
            background: rgba(197, 160, 89, 0.05);
        }

        .soul-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .soul-name {
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            color: var(--gold);
            margin: 0;
        }

        .soul-archetype {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            margin: 0;
        }

        .soul-remove {
            color: var(--text-dim);
            font-size: 0.9rem;
            padding: 4px;
            cursor: pointer;
            transition: 0.2s;
        }

        .soul-remove:hover {
            color: var(--blood);
        }

        /* Soul Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--panel-dark);
            border: 1px solid var(--gold-dim);
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            position: relative;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--gold-dim) transparent;
        }

        .modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: var(--gold-dim);
            border-radius: 3px;
        }

        .close-modal {
            position: sticky;
            top: -20px;
            float: right;
            margin-right: -20px;
            color: var(--gold);
            cursor: pointer;
            font-size: 1.8rem;
            z-index: 10;
            background: var(--panel-dark);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 1px solid var(--border-subtle);
        }

        .soul-details h2 {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            margin-bottom: 10px;
        }

        .soul-details p {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .soul-details .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            color: var(--gold-dim);
            font-size: 0.8rem;
        }

        /* GUIDE MODAL */
        .guide-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .guide-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-subtle);
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .guide-item:hover {
            border-color: var(--gold-dim);
            background: rgba(197, 160, 89, 0.05);
            transform: translateY(-2px);
        }

        .guide-icon {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .guide-title {
            font-family: 'Cinzel', serif;
            color: var(--gold);
            font-size: 1rem;
            font-weight: 600;
        }

        .guide-desc {
            font-size: 0.85rem;
            color: var(--text-dim);
            line-height: 1.5;
        }

        .btn-help {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 1px solid var(--gold-dim);
            background: transparent;
            color: var(--gold);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
            margin-left: 5px;
        }

        .btn-help:hover {
            background: var(--gold);
            color: #000;
            box-shadow: 0 0 15px rgba(197, 160, 89, 0.4);
        }

        /* PAYWALL MODAL SPECIAL STYLES */
        .paywall-content {
            text-align: center;
            padding: 40px 20px;
        }

        .paywall-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
            filter: drop-shadow(0 0 10px var(--gold));
        }

        .paywall-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--gold);
            margin-bottom: 15px;
        }

        .paywall-text {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1rem;
            line-height: 1.6;
        }

        .btn-upgrade-now {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dim) 100%);
            color: black;
            padding: 15px 40px;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            text-decoration: none;
            font-size: 1.1rem;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(197, 160, 89, 0.4);
            border: none;
            cursor: pointer;
        }

        .btn-upgrade-now:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 30px rgba(197, 160, 89, 0.6);
        }

        /* ========== CENTER: EDITOR ========== */
        .editor-area {
            background: linear-gradient(135deg, #0a0a10 0%, #08080c 100%);
            padding: 40px;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            position: relative;
        }

        /* Subtle vignette effect */
        .editor-area::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(0, 0, 0, 0.4) 100%);
            pointer-events: none;
        }

        .book-container {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 720px;
        }

        .book-page {
            background: var(--paper);
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            min-height: 900px;
            padding: 50px 60px 60px;
            box-shadow:
                0 0 0 1px rgba(0, 0, 0, 0.1),
                0 4px 20px rgba(0, 0, 0, 0.3),
                0 20px 60px rgba(0, 0, 0, 0.5),
                inset 0 0 80px rgba(0, 0, 0, 0.03);
            border-radius: 2px;
            position: relative;
            transition: all 0.3s ease;
        }

        /* Page fold effect */
        .book-page::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--paper-dark) 50%, transparent 50%);
            box-shadow: -2px 2px 5px rgba(0, 0, 0, 0.1);
        }

        .chapter-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            color: var(--ink-light);
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 4px;
            transition: all 0.2s;
            background: transparent;
            border: none;
        }

        .nav-btn:hover:not(.disabled) {
            color: var(--ink);
            background: rgba(0, 0, 0, 0.05);
        }

        .nav-btn.disabled {
            opacity: 0.3;
            cursor: default;
        }

        .chapter-indicator {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            color: var(--ink-light);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .chapter-title-input {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            font-weight: 600;
            text-align: center;
            color: var(--ink);
            border: none;
            background: transparent;
            width: 100%;
            margin-bottom: 40px;
            padding: 10px 0;
            border-bottom: 2px solid transparent;
            transition: border-color 0.3s;
            outline: none;
        }

        .chapter-title-input:focus {
            border-bottom-color: var(--gold-dim);
        }

        .editor-content {
            font-family: 'EB Garamond', serif;
            font-size: 1.3rem;
            line-height: 1.7;
            color: var(--ink);
            min-height: 600px;
            outline: none;
            letter-spacing: -0.01em;
        }

        .editor-content p {
            margin-bottom: 1.5em;
            text-align: justify;
            text-indent: 2em;
        }

        .editor-content p:first-child {
            text-indent: 0;
        }

        .editor-content p:first-child::first-letter {
            font-size: 3.5em;
            float: left;
            line-height: 0.8;
            margin-right: 8px;
            margin-top: 6px;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            color: var(--gold-dim);
        }

        /* Floating Toolbar */
        .editor-toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .book-page:hover .editor-toolbar {
            opacity: 1;
        }

        .tool-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.9);
            color: var(--ink-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: var(--gold);
            color: #fff;
            border-color: var(--gold);
            box-shadow: 0 2px 8px rgba(197, 160, 89, 0.4);
        }

        /* ========== RIGHT PANEL: ORACLE ========== */
        .panel-oracle {
            /* Leather Texture Base - Matching Left Panel */
            background-color: #1a1210;
            background-image:
                radial-gradient(ellipse at 70% 30%, rgba(60, 40, 25, 0.3) 0%, transparent 50%),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.15'/%3E%3C/svg%3E");
            border-left: 4px solid #3d2817;
            box-shadow: inset 3px 0 8px rgba(0, 0, 0, 0.5), -2px 0 4px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }

        /* Leather Stitching on Left Edge */
        .panel-oracle::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background:
                repeating-linear-gradient(180deg,
                    transparent 0px, transparent 6px,
                    var(--gold-dim) 7px, var(--gold-dim) 9px,
                    transparent 10px, transparent 16px);
            pointer-events: none;
        }

        /* Gold Corner Stud */
        .panel-oracle::before {
            content: '◉';
            position: absolute;
            left: 8px;
            top: 8px;
            color: var(--gold);
            font-size: 0.5rem;
            text-shadow: 0 0 3px var(--gold-dim);
            z-index: 10;
        }

        .oracle-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-subtle);
            position: relative;
        }

        .oracle-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            right: 20%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
        }

        .oracle-title {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gold);
            letter-spacing: 3px;
            margin-bottom: 4px;
        }

        .oracle-subtitle {
            font-size: 0.65rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .oracle-eye-container {
            padding: 16px;
            display: flex;
            justify-content: center;
            flex-shrink: 0;
        }

        .oracle-eye {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #1a1a25, #0a0a0f);
            border: 2px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow:
                inset 0 0 20px rgba(0, 0, 0, 0.8),
                0 0 15px rgba(0, 0, 0, 0.5);
        }

        .oracle-eye::before {
            content: '';
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--gold-dim);
            animation: oracle-pulse 3s ease-in-out infinite;
        }

        .oracle-eye::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--gold);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--gold), 0 0 20px var(--gold);
            animation: oracle-glow 3s ease-in-out infinite;
        }

        @keyframes oracle-pulse {

            0%,
            100% {
                transform: scale(0.9);
                opacity: 0.4;
                border-color: var(--gold-dim);
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
                border-color: var(--gold);
            }
        }

        @keyframes oracle-glow {

            0%,
            100% {
                opacity: 0.6;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .oracle-section {
            padding: 0 16px 16px;
            flex-shrink: 0;
        }

        .section-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .tension-container {
            background: var(--panel-lighter);
            border-radius: 8px;
            padding: 14px;
            border: 1px solid var(--border-subtle);
        }

        .tension-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .tension-value {
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--gold);
        }

        .tension-label {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .tension-bar {
            height: 8px;
            background: var(--panel-dark);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .tension-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg,
                    var(--emerald) 0%,
                    var(--gold) 50%,
                    var(--blood) 100%);
            width: 15%;
            transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
            position: relative;
        }

        .tension-fill::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 20px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3));
        }

        .tension-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.65rem;
            color: var(--text-dim);
        }

        .suggestions-container {
            flex: 1;
            min-height: 100px;
            overflow-y: auto;
            padding: 0 16px 16px;
        }

        .suggestion-card {
            background: var(--panel-lighter);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .suggestion-card:hover {
            border-color: var(--gold-dim);
            background: var(--panel-mid);
        }

        .suggestion-type {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .suggestion-type::before {
            content: '';
            width: 4px;
            height: 4px;
            background: var(--gold);
            border-radius: 50%;
        }

        .suggestion-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .oracle-actions {
            padding: 16px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-shrink: 0;
        }

        .btn-oracle {
            width: 100%;
            padding: 12px 14px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: var(--panel-lighter);
            color: var(--text-secondary);
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            text-align: left;
        }

        .btn-oracle:hover {
            background: var(--panel-mid);
            border-color: var(--gold-dim);
            color: var(--gold);
        }

        .btn-oracle.primary {
            background: linear-gradient(135deg, rgba(197, 160, 89, 0.15), rgba(197, 160, 89, 0.05));
            border-color: var(--gold-dim);
            color: var(--gold);
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
            justify-content: center;
        }

        .btn-oracle.primary:hover {
            background: linear-gradient(135deg, var(--gold), var(--gold-dim));
            color: #000;
            box-shadow: 0 4px 15px rgba(197, 160, 89, 0.3);
        }

        .btn-icon {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .btn-label {
            flex: 1;
        }

        .btn-label small {
            display: block;
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 2px;
        }

        /* ========== SCROLLBAR ========== */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-subtle);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gold-dim);
        }

        /* ========== UTILITY ========== */
        /* Aria Co-pilot Styles */
        .aria-chat-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            flex: 1;
            /* Expand to fill space */
            background: rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .aria-messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scrollbar-width: thin;
        }

        .aria-msg {
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.85rem;
            line-height: 1.4;
            max-width: 90%;
            animation: fadeIn 0.3s;
        }

        .aria-msg.ai {
            background: rgba(197, 160, 89, 0.1);
            border: 1px solid rgba(197, 160, 89, 0.2);
            color: var(--text-primary);
            align-self: flex-start;
        }

        .aria-msg.user {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            align-self: flex-end;
        }

        .push-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
            padding: 4px 10px;
            background: rgba(197, 160, 89, 0.15);
            border: 1px solid var(--gold-dim);
            border-radius: 4px;
            color: var(--gold);
            font-size: 0.7rem;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
            font-weight: 600;
        }

        .push-btn:hover {
            background: var(--gold);
            color: #000;
        }

        .aria-input-group {
            display: flex;
            gap: 8px;
            background: var(--panel-lighter);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 4px 8px;
        }

        .aria-input-group:focus-within {
            border-color: var(--gold);
        }

        .aria-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            padding: 8px;
            outline: none;
            font-size: 0.85rem;
        }

        .aria-btn {
            background: transparent;
            border: none;
            color: var(--gold);
            cursor: pointer;
            padding: 4px 8px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 30px;
            height: 16px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--panel-mid);
            transition: .4s;
            border-radius: 16px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-dim);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--gold-dim);
        }

        input:checked+.slider:before {
            transform: translateX(14px);
            background-color: var(--gold);
        }

        .ghost-text {
            color: var(--text-dim);
            opacity: 0.6;
            font-style: italic;
        }

        .soul-toast {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--panel-dark);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            display: none;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
            max-width: 300px;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* HEADER TOOLS STYLES */
        .header-mid-group {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 0 20px;
            flex: 1;
            justify-content: center;
        }

        .tool-separator {
            width: 1px;
            height: 24px;
            background: var(--border-subtle);
        }

        .header-tension {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid var(--border-subtle);
        }

        .header-tension-bar {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .header-tension-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--emerald) 0%, var(--gold) 100%);
            width: 0%;
            transition: width 0.5s ease;
        }

        .header-tools-row {
            display: flex;
            gap: 6px;
        }

        .btn-tool-header {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .btn-tool-header:hover {
            background: var(--panel-lighter);
            color: var(--gold);
            border-color: var(--gold-dim);
            transform: translateY(-2px);
        }

        .btn-tool-header.chaos {
            color: #d7ccc8;
            border-color: #8d6e63;
        }

        .btn-tool-header.chaos:hover {
            background: linear-gradient(135deg, #5d4037, #3e2723);
            box-shadow: 0 0 10px rgba(141, 110, 99, 0.4);
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header class="forge-header">
        <a href="index.html" class="brand" style="text-decoration: none; cursor: pointer;" title="Regresar al Inicio">
            <div class="brand-icon" style="filter: drop-shadow(0 0 5px var(--gold));">⚔️</div>
            <span class="brand-text" style="color: var(--gold); border-bottom: 2px solid transparent; transition: 0.3s;"
                onmouseover="this.style.borderColor='var(--gold-dim)'"
                onmouseout="this.style.borderColor='transparent'">SOULFORGE</span>
        </a>

        <!-- NEW CENTER TOOLS -->
        <div class="header-mid-group">
            <!-- Tension -->
            <div class="header-tension" title="Nivel de Tensión Narrativa">
                <span id="tensionLabel"
                    style="font-size:0.7rem; color:var(--text-dim); min-width: 45px; text-align:right;">NEUTRO</span>
                <div class="header-tension-bar">
                    <div id="tensionMeter" class="header-tension-fill"></div>
                </div>
                <span id="tensionValue" style="font-size:0.8rem; font-weight:600; color:var(--gold);">0%</span>
            </div>

            <div class="tool-separator"></div>

            <!-- Inspiration Tools -->
            <div class="header-tools-row">
                <button class="btn-tool-header chaos" onclick="suggestChaos()"
                    title="Dado de Caos: Introduce un evento aleatorio">⚅</button>
                <button class="btn-tool-header" onclick="suggestTwist()" title="Giro de Trama">⟳</button>
                <button class="btn-tool-header" onclick="suggestSensory()" title="Detalle Sensorial">✧</button>
                <button class="btn-tool-header" onclick="suggestDialogue()" title="Diálogo">❝</button>
                <button class="btn-tool-header" onclick="suggestAction()" title="Acción">⚔</button>
                <button class="btn-tool-header" onclick="suggestEmotion()" title="Emoción Interina">◉</button>
            </div>
        </div>

        <div class="header-controls">
            <a href="planes.html" class="btn-header" style="text-decoration: none;">
                ◆ Planes
            </a>
            <button class="btn-header" onclick="document.getElementById('fileInput').click()">
                ⟰ Cargar
            </button>
            <input type="file" id="fileInput" style="display:none" onchange="loadBookFile(this)" accept=".json">

            <button class="btn-header primary" onclick="saveBook()">
                ⬡ Guardar
            </button>

            <a href="index.html" class="btn-header" style="text-decoration:none;">
                ⌂ Inicio
            </a>

            <div class="status-badge" id="user-display" style="cursor:pointer;" onclick="toggleProfileModal()">
                <div id="statusDot" class="status-dot"></div>
                <span id="user-name-label">Invitado</span>
            </div>
            <div style="margin-left: 15px; display: flex; align-items: center; gap: 10px;">
                <!-- Mode Switcher -->
                <div class="mode-switch-group"
                    style="display:flex; border:1px solid var(--border-subtle); border-radius:6px; overflow:hidden;">
                    <button id="btnModeFic" class="btn-header"
                        style="border:none; border-radius:0; font-size:0.65rem; padding:4px 8px; background:var(--gold); color:black;"
                        onclick="setWritingMode('FICTION')">FICCION</button>
                    <button id="btnModeNon" class="btn-header"
                        style="border:none; border-radius:0; font-size:0.65rem; padding:4px 8px;"
                        onclick="setWritingMode('NON_FICTION')">NO-FIC</button>
                </div>

                <label class="switch" title="Modo Escritura Fantasma">
                    <input type="checkbox" id="ghostModeToggle" onchange="toggleGhostMode()">
                    <span class="slider round"></span>
                </label>
                <span class="ghost-label" style="font-size: 0.7rem; color: var(--text-dim);">FANTASMA</span>

                <button class="btn-help" onclick="toggleGuide()" title="Guía de Inicio">?</button>
            </div>
        </div>
    </header>

    <!-- Modal para Guardar Libro (Multi-formato) -->
    <div id="saveModal" class="modal">
        <div class="modal-content" style="max-width: 450px; text-align: center;">
            <span class="close-modal" onclick="document.getElementById('saveModal').style.display='none'">&times;</span>
            <div style="font-size: 3rem; margin-bottom: 10px;">💾</div>
            <h2 style="font-family: 'Cinzel', serif; color: var(--gold); margin-bottom: 15px;">PRESERVAR MANUSCRITO</h2>
            <p style="color: var(--text-dim); margin-bottom: 25px;">Elige el formato en el que Daithon debe sellar tu
                historia.</p>

            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button class="btn-header primary" style="justify-content: center; width: 100%;"
                    onclick="exportFormat('json')">
                    📦 Formato SoulForge (.json)
                </button>
                <div style="font-size: 0.7rem; color: #888; margin-bottom: 5px;">Recomendado para seguir escribiendo
                    después.</div>

                <button class="btn-header" style="justify-content: center; width: 100%;" onclick="exportFormat('html')">
                    🎨 Impresión Premium (.html)
                </button>

                <button class="btn-header" style="justify-content: center; width: 100%;" onclick="exportFormat('txt')">
                    📝 Archivo de Texto (.txt)
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Identificación (Login) -->
    <div id="login-modal" class="modal"
        style="display:none; align-items:center; justify-content:center; backdrop-filter:blur(15px);">
        <div class="card"
            style="max-width:400px; width:90%; position:relative; border: 2px solid var(--accent); box-shadow: 0 0 50px rgba(212, 175, 55, 0.2); background: radial-gradient(circle at top, #161920, #080a0e); padding: 40px; border-radius: 20px;">
            <button onclick="document.getElementById('login-modal').style.display='none'"
                style="position:absolute; top:20px; right:20px; background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:1.8rem; transition: 0.3s;"
                onmouseover="this.style.color='var(--accent)'"
                onmouseout="this.style.color='var(--text-dim)'">&times;</button>

            <div style="text-align:center; margin-bottom: 30px;">
                <div style="font-size: 3rem; margin-bottom: 10px;">🛡️</div>
                <h2
                    style="text-align:center; border:none; padding:0; margin:0; font-family: 'Cinzel', serif; font-size: 1.5rem; letter-spacing: 2px; color: var(--accent);">
                    IDENTIFICACIÓN DE ALMA</h2>
                <div style="height: 1px; width: 60px; background: var(--accent); margin: 15px auto; opacity: 0.5;">
                </div>
                <p style="text-align:center; font-size: 0.9rem; margin: 0; color: var(--text-primary);">Accede a la
                    sabiduría del Bibliotecario Daithon para salvaguardar tu progreso.</p>
            </div>

            <div id="auth-buttons" style="display: flex; flex-direction: column; gap: 15px;">
                <button onclick="loginWithGoogle()"
                    style="display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; padding: 14px; background: #fff; color: #000; border: none; border-radius: 12px; font-family: 'Inter', sans-serif; font-weight: 600; cursor: pointer; transition: 0.3s;">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"
                        height="20">
                    Continuar con Google
                </button>
            </div>

            <p id="login-error"
                style="display:none; color: #ff4d4d; font-size: 0.8rem; text-align: center; margin-top: 20px; background: rgba(255, 77, 77, 0.1); padding: 10px; border-radius: 8px; border: 1px solid rgba(255, 77, 77, 0.2);">
            </p>
        </div>
    </div>

    <!-- Workspace -->
    <div class="workspace">

        <!-- LEFT: SOULS PANEL -->
        <aside class="panel-souls">
            <div class="panel-header">
                <h3 id="soulPanelTitle">ALMAS CARGADAS</h3>
                <span id="soulCount">0 de 5 perfiles</span>
            </div>

            <div id="dropZone" class="soul-drop-zone" style="padding: 12px 10px; border-width: 1px;">
                <div class="drop-text">
                    <button id="btnLinkSoul" class="btn-oracle primary"
                        style="font-size: 0.65rem; padding: 5px; width: 100%; border-radius: 4px;"
                        onclick="document.getElementById('soulInput').click()">+ VINCULAR ALMA</button>
                    <input type="file" id="soulInput" style="display:none" onchange="handleFiles(this.files)"
                        accept=".html" multiple>
                    <div style="font-size: 0.6rem; margin-top: 5px; color: var(--text-dim); opacity: 0.6;">O arrastra
                        archivos aquí</div>
                </div>
            </div>

            <div id="soulList" class="soul-list" style="flex: 1; padding: 10px 0; overflow-y: auto;">
                <!-- Souls will be added here -->
            </div>

            <!-- Tools moved to header -->

        </aside>

        <!-- CENTER: EDITOR -->
        <main class="editor-area">
            <div class="book-container">
                <div class="book-page">

                    <!-- Floating Toolbar -->
                    <div class="editor-toolbar">
                        <button class="tool-btn" onclick="suggestIntro()" title="Sugerir Inicio">💡</button>
                        <button class="tool-btn" onclick="formatText('bold')" title="Negrita"><b>B</b></button>
                        <button class="tool-btn" onclick="formatText('italic')" title="Cursiva"><i>I</i></button>
                        <button class="tool-btn" onclick="formatText('underline')" title="Subrayado"><u>U</u></button>
                    </div>

                    <!-- Chapter Navigation -->
                    <nav class="chapter-nav">
                        <button class="nav-btn disabled" id="prevChap" onclick="changeChapter(-1)">
                            ❮ Anterior
                        </button>
                        <span id="chapterIndicator" class="chapter-indicator">Capítulo 1 de 1</span>
                        <button class="nav-btn" id="nextChap" onclick="changeChapter(1)">
                            Nuevo +
                        </button>
                    </nav>

                    <!-- Chapter Title -->
                    <input type="text" id="chapterTitle" class="chapter-title-input" value="Capítulo I: El Comienzo"
                        placeholder="Título del Capítulo">

                    <!-- Editor Content -->
                    <div id="editor" class="editor-content" contenteditable="true" spellcheck="false">
                        <p>La noche caía sobre las Tierras Fronterizas. El silencio era absoluto, roto solo por el
                            crepitar de la fogata. Las sombras danzaban contra los árboles centenarios, creando figuras
                            que parecían susurrar secretos olvidados.</p>
                        <p>El guerrero observaba las llamas con la mirada perdida. En sus ojos se reflejaba algo más que
                            el fuego: memorias de batallas pasadas, promesas rotas, y el peso de un destino que aún no
                            comprendía del todo.</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- RIGHT: ORACLE PANEL -->
        <aside class="panel-oracle" style="display: flex; flex-direction: column; height: 100%;">
            <div class="oracle-header">
                <div class="oracle-title">DAITHON : CO-PILOTO</div>
                <div id="aiStatus" class="oracle-subtitle">Sistema en Línea</div>
            </div>

            <!-- AI CHAT INTEGRATION - Now occupying full height -->
            <div class="aria-chat-section"
                style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 16px;">
                <div id="ariaMessages" class="aria-messages" style="flex: 1; overflow-y: auto; margin-bottom: 12px;">
                    <div class="aria-msg ai">Hola, soy Daithon. Como guardián de estos archivos, estoy listo para
                        ayudarte
                        a tejer tu historia. ¿Sobre qué quieres escribir hoy?</div>
                </div>
                <div class="aria-input-group" style="flex-shrink: 0;">
                    <input type="text" id="ariaInput" class="aria-input" placeholder="Consulta al Bibliotecario..."
                        onkeypress="if(event.key==='Enter') sendToAria()">
                    <button class="aria-btn" onclick="sendToAria()">➤</button>
                </div>
            </div>
        </aside>

    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <span class="close-modal" onclick="toggleProfileModal()">&times;</span>
            <div id="profile-pic-container" style="margin-bottom: 20px;">
                <div style="font-size: 4rem; margin-bottom: 10px;">👤</div>
            </div>
            <h2 id="profile-name" style="font-family: 'Cinzel', serif; color: var(--gold); margin-bottom: 5px;">Nombre
                de Guerrero</h2>
            <p id="profile-email" style="color: var(--text-dim); font-size: 0.9rem; margin-bottom: 20px;">
                email@ejemplo.com</p>

            <div
                style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; margin-bottom: 25px; border: 1px solid var(--border-subtle);">
                <div
                    style="font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px;">
                    Rango Actual</div>
                <div id="profile-tier"
                    style="font-family: 'Cinzel', serif; color: var(--gold); font-size: 1.2rem; filter: drop-shadow(0 0 5px var(--gold-dim)); text-transform: uppercase;">
                    Novato</div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn-header" style="justify-content: center;"
                    onclick="window.location.href='planes.html'">Subir de Nivel (Planes)</button>
                <button class="btn-header"
                    style="justify-content: center; border-color: rgba(255,0,0,0.3); color: #ff4d4d;"
                    onclick="logout()">Cerrar Sesión</button>
            </div>
        </div>
    </div>

    <!-- Guide Modal -->
    <div id="guideModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-modal" onclick="toggleGuide()">&times;</span>
            <h2 style="font-family: 'Cinzel', serif; color: var(--gold); margin-bottom: 10px;">BIBLIOTECA DE ALMAS: GUÍA
                DE INICIO</h2>
            <p style="color: var(--text-dim); font-size: 0.9rem;">Bienvenido, Forjador. Aquí tienes las herramientas
                para tejer tu destino.</p>

            <div class="guide-grid">
                <div class="guide-item">
                    <span class="guide-icon">🎭</span>
                    <span class="guide-title">Modos de Escritura</span>
                    <p class="guide-desc"><b>Ficción:</b> Enfocado en la narrativa, tensión y
                        creatividad.<br><b>No-Fic:</b> Enfocado en impacto, claridad y persuasión.</p>
                </div>
                <div class="guide-item">
                    <span class="guide-icon">🌡️</span>
                    <span class="guide-title">Indicador de Impacto</span>
                    <p class="guide-desc">Mide la intensidad de tu texto en tiempo real. Varía entre Clímax (Ficción) o
                        Máximo Valor (No-Ficción).</p>
                </div>
                <div class="guide-item">
                    <span class="guide-icon">🎲</span>
                    <span class="guide-title">Herramientas de Inspiración</span>
                    <p class="guide-desc">Usa el Dado de Caos o los disparadores (Giro, Sentidos, Diálogo) para recibir
                        sugerencias contextuales de Daithon.</p>
                </div>
                <div class="guide-item">
                    <span class="guide-icon">✨</span>
                    <span class="guide-title">Daithon: Co-Piloto</span>
                    <p class="guide-desc">Tu guía. Analiza tus "Almas" (personajes o lectores) para darte
                        consejos precisos sobre qué escribir.</p>
                </div>
                <div class="guide-item">
                    <span class="guide-icon">👻</span>
                    <span class="guide-title">Escritura Fantasma</span>
                    <p class="guide-desc">Si te bloqueas, Daithon puede materializar el siguiente párrafo basándose en
                        tu
                        estilo y en las almas cargadas.</p>
                </div>
                <div class="guide-item">
                    <span class="guide-icon">🌌</span>
                    <span class="guide-title">Sonidos para Concentración</span>
                    <p class="guide-desc">Sonidos blancos (Lluvia, Fuego, Ambiente) diseñados para el enfoque profundo y
                        la relajación mientras escribes.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Soul Detail Modal -->
    <div id="soulModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSoulModal()">&times;</span>
            <div id="soulDetails" class="soul-details">
                <!-- Content generated via JS -->
            </div>
        </div>
    </div>

    <!-- Paywall/Usage Limit Modal -->
    <div id="paywallModal" class="modal">
        <div class="modal-content">
            <span class="close-modal"
                onclick="document.getElementById('paywallModal').style.display='none'">&times;</span>
            <div class="paywall-content">
                <span class="paywall-icon">💎</span>
                <h2 class="paywall-title">Límite de Daithon Alcanzado</h2>
                <p class="paywall-text">Has agotado tus 5 consultas diarias del Plan Novato. La sabiduría del
                    Bibliotecario requiere más energía espiritual para continuar hoy.</p>
                <a href="planes.html" class="btn-upgrade-now">Suscribirse para Consultas Ilimitadas</a>
                <p style="margin-top: 20px; font-size: 0.8rem; color: var(--text-dim);">Tus usos se recargarán mañana
                    automáticamente.</p>
            </div>
        </div>
    </div>

    <!-- Soul Toast -->
    <div id="soulToast" class="soul-toast"></div>

    <!-- Fire Glow Overlay (Multi-layered for organic effect) -->
    <div id="fire-glow-base" class="fire-layer"></div>
    <div id="fire-glow-flicker" class="fire-layer"></div>

    <!-- Ambience Controls -->
    <div class="ambience-dock">
        <button class="btn-ambience" onclick="playAmbience('rain')" title="Lluvia (Ruido Blanco / Enfoque)">🌧️</button>
        <button class="btn-ambience" onclick="playAmbience('fire')" title="Fuego (Relajación / Calidez)">🔥</button>
        <button class="btn-ambience" onclick="playAmbience('tavern')" title="Ambiente (Foco Social)">🍺</button>
        <div class="volume-slider">
            <input type="range" min="0" max="1" step="0.1" value="0.5" oninput="setGlobalVolume(this.value)"
                style="width:50px;">
        </div>
    </div>

    <!-- Audio Sources (Fresh IDs to avoid cache conflicts) -->
    <audio id="sfx-rain-new" loop src="https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg"
        onerror="addAriaMsg('system', '⚠️ Error lluvia')"></audio>
    <!-- Fire: Tried fireplace.ogg, now trying fire.ogg + 2 backups -->
    <audio id="sfx-fire-new" loop src="https://actions.google.com/sounds/v1/ambiences/fire.ogg"
        onerror="handleFireError(this)"></audio>
    <audio id="sfx-tavern-new" loop src="https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg"
        onerror="addAriaMsg('system', '⚠️ Error taberna')"></audio>

    <!-- JavaScript -->
    <script>
        // === ENVIRONMENT DETECTION ===
        const DIRECT_MODE = true;
        // Split key to avoid repo scanners
        const _k1 = 'gsk_Q0yQ7SLBpmnYbIT9';
        const _k2 = '9yl3WGdyb3FY8Mew5qM8YPDSNYKCdWJPGKZ5';
        const GROQ_KEY = _k1 + _k2;

        const CLOUD_API = 'https://soulforge.up.railway.app';
        const LOCAL_API = 'http://localhost:8080'; // Still here, but unused in DIRECT_MODE
        const LOCAL_TTS = 'http://localhost:3456';

        // === ARIA CORE CONFIG ===
        const CONFIG = {
            name: 'Daithon',
            model: 'llama-3.3-70b-versatile', // Groq Flagship Model
            apiEndpoint: 'https://api.groq.com/openai/v1/chat/completions',
            ttsHost: LOCAL_TTS, // Keep local Voice
            mute: false,
            usageLimit: 5
        };

        const ARIA_STATE = {
            context: [],
            thinking: false,
            speaking: false,
            ghostMode: false,
            writingMode: 'FICTION', // Default
            lastTypingTime: Date.now()
        };
        // State
        let engineReady = false;
        let loadedSouls = []; // Array of objects: { name, archetype, bio, stats }
        let currentChapterIndex = 0;
        let bookData = {
            title: "Mi Nueva Historia",
            chapters: [
                {
                    title: "Capítulo I: El Comienzo",
                    content: `<p>La noche caía sobre las Tierras Fronterizas. El silencio era absoluto, roto solo por el
                            crepitar de la fogata. Las sombras danzaban contra los árboles centenarios, creando figuras
                            que parecían susurrar secretos olvidados.</p><p>El guerrero observaba las llamas con la mirada perdida. En sus ojos se reflejaba algo más que
                            el fuego: memorias de batallas pasadas, promesas rotas, y el peso de un destino que aún no
                            comprendía del todo.</p>`
                }
            ]
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await initEngine();
            updateUI();
            setupDragDrop();

            const editor = document.getElementById('editor');
            editor.addEventListener('input', () => {
                saveCurrentChapter(); // Draft saving
                ARIA_STATE.lastTypingTime = Date.now();
                analyzeTension();
                removeGhostSuggestion();
            });

            setInterval(checkIdle, 1000);

            // Sync User State
            auth.onAuthStateChanged(async user => {
                const userDisplay = document.getElementById('user-name-label');
                const dot = document.getElementById('statusDot');

                if (user) {
                    const name = user.displayName || user.email.split('@')[0];
                    userDisplay.textContent = name;
                    dot.style.background = '#4ade80';

                    // Populate Profile Modal
                    if (document.getElementById('profile-name')) {
                        document.getElementById('profile-name').textContent = name.toUpperCase();
                        document.getElementById('profile-email').textContent = user.email;
                    }

                    const userRef = db.collection('usuarios').doc(user.uid);
                    const doc = await userRef.get();
                    if (doc.exists) {
                        const data = doc.data();
                        const tier = data.plan_activo || 'gratis';
                        localStorage.setItem('soulforge_tier', tier);

                        if (document.getElementById('profile-tier')) {
                            document.getElementById('profile-tier').textContent = tier.toUpperCase();
                        }

                        if (data.usage && data.usage.date === new Date().toDateString()) {
                            localStorage.setItem('aria_usage', JSON.stringify(data.usage));
                        }
                    }
                } else {
                    userDisplay.textContent = 'Invitado';
                    dot.style.background = 'var(--gold-dim)';
                    localStorage.setItem('soulforge_tier', 'gratis');
                }
            });
        });

        function toggleProfileModal() {
            if (!auth.currentUser) {
                showLogin();
                return;
            }
            const m = document.getElementById('profileModal');
            if (m) m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
        }

        async function logout() {
            if (confirm("¿Deseas cerrar tu sesión en la Fragua?")) {
                await auth.signOut();
                window.location.reload();
            }
        }

        // === AUTH HANDLERS ===
        function showLogin() {
            const m = document.getElementById('login-modal');
            if (m) m.style.display = 'flex';
        }

        async function loginWithGoogle() {
            if (window.location.protocol === 'file:') {
                alert("⚠️ Google Login requiere un servidor (ej: Live Server).");
                return;
            }
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
                const m = document.getElementById('login-modal');
                if (m) m.style.display = 'none';
                addAriaMsg('system', '✨ Bienhallado. Tu alma ha sido identificada.');
            } catch (err) {
                console.error(err);
                const errEl = document.getElementById('login-error');
                if (errEl) {
                    errEl.textContent = err.message;
                    errEl.style.display = 'block';
                }
            }
        }

        async function initEngine() {
            await new Promise(r => setTimeout(r, 800));
            engineReady = true;
            const dot = document.getElementById('statusDot');
            if (dot) dot.classList.add('active');

            const userLabel = document.getElementById('user-name-label');
            if (userLabel && !auth.currentUser) {
                userLabel.textContent = 'En Línea';
            }
        }

        function updateUI() {
            const chap = bookData.chapters[currentChapterIndex];
            document.getElementById('chapterTitle').value = chap.title;
            document.getElementById('editor').innerHTML = chap.content;
            document.getElementById('chapterIndicator').textContent =
                `Capítulo ${currentChapterIndex + 1} de ${bookData.chapters.length}`;

            // Navigation buttons
            const prevBtn = document.getElementById('prevChap');
            const nextBtn = document.getElementById('nextChap');

            prevBtn.classList.toggle('disabled', currentChapterIndex === 0);

            if (currentChapterIndex === bookData.chapters.length - 1) {
                nextBtn.textContent = 'Nuevo +';
            } else {
                nextBtn.textContent = 'Siguiente ❯';
            }
        }

        function changeChapter(direction) {
            saveCurrentChapter();

            if (direction === 1 && currentChapterIndex === bookData.chapters.length - 1) {
                bookData.chapters.push({
                    title: `Capítulo ${romanize(bookData.chapters.length + 1)}`,
                    content: "<p>Continúa escribiendo tu historia...</p>"
                });
            }

            const newIndex = currentChapterIndex + direction;
            if (newIndex >= 0 && newIndex < bookData.chapters.length) {
                currentChapterIndex = newIndex;
                updateUI();

                // Page turn animation
                const page = document.querySelector('.book-page');
                page.style.opacity = '0';
                page.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    page.style.opacity = '1';
                    page.style.transform = 'translateY(0)';
                }, 150);
            }
        }

        function saveCurrentChapter() {
            bookData.chapters[currentChapterIndex].title = document.getElementById('chapterTitle').value;
            bookData.chapters[currentChapterIndex].content = document.getElementById('editor').innerHTML;
        }

        function saveBook() {
            saveCurrentChapter();
            document.getElementById('saveModal').style.display = 'flex';
        }

        function exportFormat(target) {
            saveCurrentChapter();
            const title = bookData.title.replace(/\s+/g, '_');
            let blob, filename;

            if (target === 'json') {
                const dataStr = JSON.stringify(bookData, null, 2);
                blob = new Blob([dataStr], { type: "application/json" });
                filename = `${title}.json`;
            } else if (target === 'txt') {
                let txt = `S O U L F O R G E   -   ${bookData.title.toUpperCase()}\n`;
                txt += `====================================================\n\n`;
                bookData.chapters.forEach((c, i) => {
                    txt += `CAPÍTULO ${i + 1}: ${c.title.toUpperCase()}\n`;
                    txt += `----------------------------------------------------\n`;
                    // Convert HTML paragraphs to plain text with newlines
                    const temp = document.createElement('div');
                    temp.innerHTML = c.content;
                    txt += temp.innerText + "\n\n";
                });
                blob = new Blob([txt], { type: "text/plain" });
                filename = `${title}.txt`;
            } else if (target === 'html') {
                let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${bookData.title}</title>`;
                html += `<link href="https://fonts.googleapis.com/css2?family=Cinzel&family=Crimson+Text:ital@0;1&display=swap" rel="stylesheet">`;
                html += `<style>body{background:#fdfcf0; color:#222; font-family:'Crimson Text', serif; padding: 5% 15%; line-height:1.6;} h1{font-family:'Cinzel'; text-align:center; color:#8a7040; margin-bottom:50px;} .chapter{margin-bottom:80px; page-break-after:always;} .chap-title{font-family:'Cinzel'; font-size:1.5rem; text-align:center; border-bottom:1px solid #ddd; padding-bottom:10px; margin-bottom:30px;}</style></head><body>`;
                html += `<h1>${bookData.title}</h1>`;
                bookData.chapters.forEach((c) => {
                    html += `<div class="chapter"><div class="chap-title">${c.title}</div>${c.content}</div>`;
                });
                html += `</body></html>`;
                blob = new Blob([html], { type: "text/html" });
                filename = `${title}_Lectura.html`;
            }

            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
            document.getElementById('saveModal').style.display = 'none';
        }

        function loadBookFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const loaded = JSON.parse(e.target.result);
                    if (loaded.chapters && Array.isArray(loaded.chapters)) {
                        bookData = loaded;
                        currentChapterIndex = 0;
                        updateUI();
                    }
                } catch (err) {
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        function suggestIntro() {
            const intros = [
                "Todo comenzó con el sonido de un cristal quebrándose en la oscuridad.",
                "Nadie recordaba cuándo había dejado de salir el sol sobre aquellas tierras.",
                "La espada pesaba más que su propia conciencia aquella noche.",
                "Era una verdad que hubiera preferido ignorar hasta el fin de sus días."
            ];
            const chosen = intros[Math.floor(Math.random() * intros.length)];
            const editor = document.getElementById('editor');
            const p = document.createElement('p');
            p.innerHTML = `<em style="color:#8a7040">${chosen}</em>`;
            editor.prepend(p);
        }

        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('editor').focus();
        }

        function getLastParagraph() {
            const editor = document.getElementById('editor');
            const text = editor.innerText.trim();
            if (!text) return "";
            const lines = text.split('\n').filter(l => l.trim() !== "");
            return lines[lines.length - 1] || "";
        }

        function getDailyUsage() {
            const today = new Date().toDateString();
            const stored = JSON.parse(localStorage.getItem('aria_usage') || '{}');
            if (stored.date !== today) {
                return { date: today, count: 0 };
            }
            return stored;
        }

        function incrementUsage() {
            const usage = getDailyUsage();
            usage.count++;
            localStorage.setItem('aria_usage', JSON.stringify(usage));

            // Sync to Firebase if identified
            if (auth.currentUser) {
                db.collection('usuarios').doc(auth.currentUser.uid).update({
                    usage: usage
                }).catch(e => console.error("Error syncing usage:", e));
            }
        }

        function checkAriaUsage() {
            // EXIGIR REGISTRO
            if (!auth.currentUser) {
                addAriaMsg('system', '⚠️ Daithon solo responde a almas identificadas. Por favor, identifícate haciendo clic en el círculo de arriba.');
                showLogin();
                return false;
            }

            const tier = localStorage.getItem('soulforge_tier');
            if (tier === 'pro' || tier === 'premium') return true;

            const usage = getDailyUsage();
            if (usage.count >= CONFIG.usageLimit) {
                document.getElementById('paywallModal').style.display = 'flex';
                return false;
            }
            return true;
        }

        // === ARIA AI ENGINE (THE LIBRARIAN) ===
        async function sendToAria() {
            const input = document.getElementById('ariaInput');
            const text = input.value.trim();
            if (!text || ARIA_STATE.thinking) return;

            if (!checkAriaUsage()) return;

            input.value = '';
            addAriaMsg('user', text);
            setAriaThinking(true);

            // Get story and souls context
            const storyTitle = document.getElementById('chapterTitle').value;
            const storyContent = document.getElementById('editor').innerText;

            // Adapt Context based on Mode
            const isNonFic = ARIA_STATE.writingMode === 'NON_FICTION';
            const soulLabel = isNonFic ? "PERFIL DEL LECTOR OBJETIVO" : "ALMAS DE PERSONAJES";

            const soulsContext = loadedSouls.length > 0
                ? `${soulLabel}:\n` + loadedSouls.map(s =>
                    `- ${s.name} (${s.archetype}): ${s.bio.substring(0, 300)}...`
                ).join('\n')
                : "No hay perfiles cargados todavía.";

            const systemInstruction = isNonFic
                ? `Eres Daithon, Coach de No-Ficción. OBJETIVO: Libro de impacto. AUDIENCIA: ${soulsContext}. INSTRUCCIÓN: Sé conciso y directo (máx 120 palabras).`
                : `Eres Daithon, el Bibliotecario. CONTEXTO: Personajes: ${soulsContext}. INSTRUCCIÓN: Sé sugerente y breve (máx 100 palabras).`;

            try {
                const reply = await fetchFromGroq(
                    [...ARIA_STATE.context, { role: 'user', content: text }],
                    `${systemInstruction}\nOBRA: "${storyTitle}"\nMANUSCRITO: ${storyContent.substring(0, 800)}`
                );

                if (reply) {
                    incrementUsage();
                    addAriaMsg('ai', reply);

                    ARIA_STATE.context.push({ role: 'user', content: text });
                    ARIA_STATE.context.push({ role: 'assistant', content: reply });
                    if (ARIA_STATE.context.length > 10) ARIA_STATE.context.shift();
                }
            } catch (err) {
                console.error("Chat Error:", err);
                addAriaMsg('ai', `Mis archivos parecen cubiertos de sombras... El servidor respondió: ${err.message}`);
            } finally {
                setAriaThinking(false);
            }
        }

        // === MODES & ORACLE ===
        function setWritingMode(mode) {
            ARIA_STATE.writingMode = mode;
            const isNonFic = mode === 'NON_FICTION';

            // Buttons style
            document.getElementById('btnModeFic').style.background = isNonFic ? 'transparent' : 'var(--gold)';
            document.getElementById('btnModeFic').style.color = isNonFic ? 'var(--text-secondary)' : 'black';
            document.getElementById('btnModeNon').style.background = isNonFic ? 'var(--gold)' : 'transparent';
            document.getElementById('btnModeNon').style.color = isNonFic ? 'black' : 'var(--text-secondary)';

            // Labels
            document.getElementById('soulPanelTitle').textContent = isNonFic ? 'LECTOR OBJETIVO' : 'ALMAS CARGADAS';
            document.getElementById('soulCount').textContent = isNonFic ? `0 de 1 Perfil` : `0 de 5 Personajes`;
            document.getElementById('btnLinkSoul').textContent = isNonFic ? '+ DEFINIR LECTOR' : '+ VINCULAR ALMA';

            // Header Tools Labels (Tooltips)
            const tools = document.querySelectorAll('.btn-tool-header');
            if (isNonFic) {
                tools[0].title = "Abogado del Diablo: Generar objeción del lector"; // Chaos
                tools[1].title = "Rompe-Mitos: Dato sorprendente o corrección"; // Twist
                tools[2].title = "Metáfora: Explicar con analogía"; // Sensory
                tools[3].title = "Testimonio/Cita: Voz de autoridad"; // Dialogue
                tools[4].title = "Llamada a la Acción: Paso práctico"; // Action
                tools[5].title = "Empatía: Conectar con el dolor/deseo"; // Emotion

                // Tension Label
                document.querySelector('.header-tension').title = "Nivel de Impacto / Persuasión";
                document.getElementById('tensionLabel').textContent = "IMPACTO";
            } else {
                tools[0].title = "Dado de Caos: Evento aleatorio";
                tools[1].title = "Giro de Trama";
                tools[2].title = "Detalle Sensorial";
                tools[3].title = "Diálogo";
                tools[4].title = "Acción";
                tools[5].title = "Emoción";

                document.querySelector('.header-tension').title = "Nivel de Tensión Narrativa";
                document.getElementById('tensionLabel').textContent = "NEUTRO";
            }
        }

        async function suggestChaos() {
            if (ARIA_STATE.writingMode === 'NON_FICTION') {
                const res = await callAriaOracle('CHAOS_NF', "Genera una objeción escéptica que tendría el lector ahora mismo ('¿Y si no tengo dinero?', '¿Y si fallo?').");
                if (res) addAriaMsg('ai', `🤨 OBJECIÓN: ${res}`);
            } else {
                const res = await callAriaOracle('CHAOS', "Genera un evento aleatorio, caótico o disruptivo (un objeto se rompe, alguien llega, un sonido extraño).");
                if (res) addAriaMsg('ai', `🎲 CAOS: ${res}`);
            }
        }

        async function suggestSensory() {
            if (ARIA_STATE.writingMode === 'NON_FICTION') {
                const res = await callAriaOracle('SENSORY_NF', "Crea una metáfora o analogía brillante para explicar el concepto actual.");
                if (res) addAriaMsg('ai', res);
            } else {
                const res = await callAriaOracle('SENSORY', "Describe el entorno usando uno de los 5 sentidos. Sé evocador.");
                if (res) addAriaMsg('ai', res);
            }
        }

        async function suggestTwist() {
            if (ARIA_STATE.writingMode === 'NON_FICTION') {
                const res = await callAriaOracle('TWIST_NF', "Sugiere un dato contraintuitivo o desmiente un mito común sobre este tema.");
                if (res) addAriaMsg('ai', res);
            } else {
                const res = await callAriaOracle('TWIST', "Introduce un giro argumental inesperado que complique la situación actual.");
                if (res) addAriaMsg('ai', res);
            }
        }

        async function suggestDialogue() {
            if (ARIA_STATE.writingMode === 'NON_FICTION') {
                const res = await callAriaOracle('DIALOGUE_NF', "Genera una cita inspiradora o un breve testimonio (ficticio o real) que apoye este punto.");
                if (res) addAriaMsg('ai', res);
            } else {
                const souls = loadedSouls.map(s => s.name).join(' y ');
                const res = await callAriaOracle('DIALOGUE', `Genera un diálogo intenso y revelador entre ${souls || 'los personajes'}.`);
                if (res) addAriaMsg('ai', res);
            }
        }

        async function suggestAction() {
            if (ARIA_STATE.writingMode === 'NON_FICTION') {
                const res = await callAriaOracle('ACTION_NF', "Redacta una 'Llamada a la Acción' clara y directa para el lector.");
                if (res) addAriaMsg('ai', res);
            } else {
                const res = await callAriaOracle('ACTION', "Eleva el ritmo con una escena de acción, persecución o peligro físico.");
                if (res) addAriaMsg('ai', res);
            }
        }

        async function suggestEmotion() {
            if (ARIA_STATE.writingMode === 'NON_FICTION') {
                const res = await callAriaOracle('EMOTION_NF', "Escribe una frase empática que valide la frustración o el deseo del lector ('Sé que es difícil...').");
                if (res) addAriaMsg('ai', res);
            } else {
                const res = await callAriaOracle('EMOTION', "Focaliza en el sentimiento interno de un personaje ante lo que está ocurriendo.");
                if (res) addAriaMsg('ai', res);
            }
        }

        // === DIRECT GROQ HELPER ===
        async function fetchFromGroq(messages, systemPrompt) {
            const allMessages = [];
            if (systemPrompt) allMessages.push({ role: 'system', content: systemPrompt });
            allMessages.push(...messages);

            const response = await fetch(CONFIG.apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${GROQ_KEY}`
                },
                body: JSON.stringify({
                    model: CONFIG.model,
                    messages: allMessages,
                    temperature: 0.7,
                    max_tokens: 180
                })
            });

            if (!response.ok) {
                const err = await response.text();
                throw new Error(`Groq API Error: ${err}`);
            }

            const data = await response.json();
            return data.choices[0]?.message?.content || "";
        }

        async function callAriaOracle(type, promptText) {
            if (!checkAriaUsage()) return;
            setAriaThinking(true);

            const storyTitle = document.getElementById('chapterTitle').value;
            const lastPara = getLastParagraph();
            const soulsContext = loadedSouls.map(s => `${s.name} (${s.archetype})`).join(', ');

            const systemPrompt = `Eres Daithon, el Mentor. Sé breve y literario. CAPÍTULO: ${storyTitle}. PERSONAJES: ${soulsContext}. CONTEXTO: "${lastPara}"`;

            try {
                const reply = await fetchFromGroq([{ role: 'user', content: promptText }], systemPrompt);

                if (reply) {
                    incrementUsage();
                    addAriaMsg('ai', reply);

                    ARIA_STATE.context.push({ role: 'user', content: promptText });
                    ARIA_STATE.context.push({ role: 'assistant', content: reply });
                    if (ARIA_STATE.context.length > 10) ARIA_STATE.context.shift();
                }
            } catch (err) {
                console.error("Chat Error:", err);
                addAriaMsg('ai', `Mis archivos parecen cubiertos de sombras... (Error: ${err.message})`);
            } finally {
                setAriaThinking(false);
            }
        }

        async function speak(text) {
            if (ARIA_STATE.speaking || CONFIG.mute) return;
            ARIA_STATE.speaking = true;
            try {
                const response = await fetch(`${CONFIG.ttsHost}/speak`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.url) {
                        const audio = new Audio(data.url);
                        audio.onended = () => { ARIA_STATE.speaking = false; };
                        audio.onerror = () => { ARIA_STATE.speaking = false; };
                        await audio.play();
                        return;
                    }
                }
                throw new Error("TTS Server response invalid");
            } catch (e) {
                console.warn("TTS failed, using native fallback:", e);
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.onend = () => { ARIA_STATE.speaking = false; };
                utterance.onerror = () => { ARIA_STATE.speaking = false; };
                window.speechSynthesis.speak(utterance);
            }
        }

        function addAriaMsg(role, text) {
            const box = document.getElementById('ariaMessages');
            const div = document.createElement('div');
            div.className = `aria-msg ${role}`;

            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            div.appendChild(textSpan);

            // If it's AI and looks like narrative/dialogue, add a push button
            if (role === 'ai' && (text.length > 40 || text.includes('"') || text.includes(':'))) {
                const btn = document.createElement('button');
                btn.className = 'push-btn';
                btn.innerHTML = '🖋️ Plasmar en Libro';
                btn.onclick = () => insertInEditor(text);
                div.appendChild(btn);
            }

            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function setAriaThinking(val) {
            ARIA_STATE.thinking = val;
            const statusText = document.getElementById('aiStatus');
            if (val) {
                statusText.textContent = "Daithon está pensando...";
                statusText.style.color = "var(--gold)";
            } else {
                statusText.textContent = "SISTEMA EN LÍNEA";
                statusText.style.color = "var(--text-dim)";
            }
        }



        function insertInEditor(text) {
            const editor = document.getElementById('editor');
            removeGhostSuggestion();

            const p = document.createElement('p');
            p.innerText = text;
            editor.appendChild(p);

            if (editor.innerHTML.trim() === "") editor.innerHTML = `<p>${text}</p>`;

            saveCurrentChapter(); // Guardar al instante
            p.scrollIntoView({ behavior: 'smooth', block: 'center' });
            updateImpactGauge();
        }

        // === NEW FEATURES IMPLEMENTATION ===

        function toggleGhostMode() {
            ARIA_STATE.ghostMode = document.getElementById('ghostModeToggle').checked;
        }

        function checkIdle() {
            const idleTime = Date.now() - ARIA_STATE.lastTypingTime;

            // Ghost Writer (5s idle)
            if (ARIA_STATE.ghostMode && idleTime > 5000 && idleTime < 6000 && !ARIA_STATE.thinking) {
                triggerGhostWriter();
            }

            // Character Interjection (30s idle)
            if (idleTime > 30000 && idleTime < 31000 && loadedSouls.length > 0) {
                triggerCharacterInterjection();
            }
        }

        // Tension / Impact Logic
        function analyzeTension() {
            const text = document.getElementById('editor').innerText;
            if (text.length < 50) return;

            const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
            const lastSentences = sentences.slice(-5);
            if (lastSentences.length === 0) return;

            let tension = 0;

            if (ARIA_STATE.writingMode === 'NON_FICTION') {
                // IMPACT MODE logic
                // High Impact = Questions (?), Direct Address (tú/usted), Short lists
                let questions = 0;
                let directAddress = 0;

                lastSentences.forEach(s => {
                    if (s.includes('?')) questions++;
                    if (/\b(tú|usted|ti|tu|su)\b/i.test(s)) directAddress++;
                });

                // 20 points per question, 10 per direct address
                tension = Math.min(100, (questions * 25) + (directAddress * 15));
                // Also boost if sentences are reasonably short (punchy)
                const avgLen = lastSentences.join(' ').split(' ').length / 5;
                if (avgLen < 15) tension += 20;
                if (tension > 100) tension = 100;

                updateTensionUI(Math.round(tension), 'IMPACTO');

            } else {
                // FICTION MODE logic (Tension)
                let totalWords = 0;
                let totalExclamations = 0;

                lastSentences.forEach(s => {
                    totalWords += s.split(' ').length;
                    if (s.includes('!')) totalExclamations++;
                });

                const avgLength = totalWords / lastSentences.length;
                tension = Math.max(0, Math.min(100, (20 - avgLength) * 5 + (totalExclamations * 10)));
                updateTensionUI(Math.round(tension), 'TENSIÓN');
            }
        }

        function updateTensionUI(val, type = 'TENSIÓN') {
            const fill = document.getElementById('tensionMeter');
            const label = document.getElementById('tensionLabel');
            const num = document.getElementById('tensionValue');

            fill.style.width = val + '%';
            num.textContent = val + '%';

            if (type === 'IMPACTO') {
                // Blue/Gold gradient for impact/value
                if (val < 30) {
                    fill.style.background = '#90caf9'; // Pale blue
                    label.textContent = 'PLANO'; // Flat
                } else if (val < 70) {
                    fill.style.background = '#42a5f5'; // Blue
                    label.textContent = 'VALOR';
                } else {
                    fill.style.background = 'linear-gradient(90deg, #42a5f5, #ffd700)'; // Blue to Gold
                    label.textContent = 'CLARIDAD';
                }
            } else {
                // Red/Green for Tension
                if (val < 30) {
                    fill.style.background = '#81c784'; // Green
                    label.textContent = 'CALMA';
                } else if (val < 70) {
                    fill.style.background = '#ffd54f'; // Yellow
                    label.textContent = 'TENSIÓN';
                } else {
                    fill.style.background = '#e57373'; // Red
                    label.textContent = 'CLÍMAX';
                }
            }
        }


        // Ghost Writer Logic
        async function triggerGhostWriter() {
            const lastPara = getLastParagraph();
            if (!lastPara || lastPara.length < 20) return;

            // Create a temporary "ghost" span in editor
            const editor = document.getElementById('editor');
            let ghostSpan = document.getElementById('ghostSpan');
            if (ghostSpan) return; // Already exists

            try {
                const suggestion = await fetchFromGroq(
                    [{ role: 'user', content: lastPara }],
                    "Completa la frase del usuario. SOLO el texto de continuación literaria. Máximo 10 palabras."
                );

                if (!suggestion) return;

                // Append as ghost text
                ghostSpan = document.createElement('span');
                ghostSpan.id = 'ghostSpan';
                ghostSpan.className = 'ghost-text';
                ghostSpan.innerText = " " + suggestion + " (Tab)";
                ghostSpan.contentEditable = "false";

                // Append to last paragraph if possible
                const paragraphs = editor.querySelectorAll('p');
                if (paragraphs.length > 0) {
                    paragraphs[paragraphs.length - 1].appendChild(ghostSpan);
                } else {
                    editor.appendChild(ghostSpan);
                }

                // Add Tab listener
                editor.addEventListener('keydown', handleGhostTab);

            } catch (e) { console.log("Ghost failed", e); }
        }

        function handleGhostTab(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const ghost = document.getElementById('ghostSpan');
                if (ghost) {
                    const text = ghost.innerText.replace(" (Tab)", "");
                    ghost.remove();
                    document.execCommand('insertText', false, text);
                    removeGhostSuggestion();
                }
            }
        }

        function removeGhostSuggestion() {
            const ghost = document.getElementById('ghostSpan');
            if (ghost) {
                ghost.remove();
                document.getElementById('editor').removeEventListener('keydown', handleGhostTab);
            }
        }

        // Character Interjection Logic
        async function triggerCharacterInterjection() {
            const soul = loadedSouls[Math.floor(Math.random() * loadedSouls.length)];
            const lastPara = getLastParagraph();

            try {
                const comment = await fetchFromGroq(
                    [],
                    `Eres ${soul.name}. ${soul.archetype}. REACCIÓN CORTA (clásica de personaje, máx 15 palabras) a lo que está pasando: "${lastPara}". Habla en primera persona.`
                );

                if (comment) {
                    showSoulToast(soul.name, comment);
                    speak(comment);
                }

            } catch (e) { console.log("Interjection failed", e); }
        }

        function showSoulToast(name, text) {
            const toast = document.getElementById('soulToast');
            toast.innerHTML = `<strong>${name}</strong>: "${text}"`;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 6000);
        }

        function romanize(num) {
            const lookup = { 1: 'I', 2: 'II', 3: 'III', 4: 'IV', 5: 'V', 6: 'VI', 7: 'VII', 8: 'VIII', 9: 'IX', 10: 'X' };
            return lookup[num] || num;
        }

        function setupDragDrop() {
            const dropZone = document.getElementById('dropZone');

            dropZone.addEventListener('dragover', e => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', e => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
        }

        function handleFiles(files) {
            for (let file of files) {
                if (file.name.endsWith('.html')) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const content = e.target.result;
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(content, 'text/html');

                        // 1. Get Name (H1)
                        const name = (doc.querySelector('h1')?.textContent || file.name).trim();

                        // 2. Get Archetype (look for .archetype or first distinctive text)
                        const archetype = (doc.querySelector('.archetype')?.textContent ||
                            doc.querySelector('.hero, .tag, span')?.textContent ||
                            "Personalizado").trim().toUpperCase();

                        // 3. Extract Bio Body (Greedy but smart)
                        let bio = "";
                        const bioContainer = doc.querySelector('.bio, .biography, .content, body');

                        if (bioContainer) {
                            // If it's the body, let's filter out the H1 and navigation
                            const clone = bioContainer.cloneNode(true);
                            clone.querySelectorAll('h1, script, style, nav').forEach(el => el.remove());
                            bio = clone.innerText.trim();
                        }

                        // 4. Extract Stats/Details
                        const stats = [];
                        doc.querySelectorAll('span, li, p').forEach(el => {
                            const txt = el.textContent.trim();
                            if (txt.includes(':') && txt.length < 100) stats.push(txt);
                            else if (el.classList.contains('stat')) stats.push(txt);
                        });

                        addSoulToList({ name, archetype, bio: bio || "Biografía extraída del archivo.", stats: stats.slice(0, 8) });
                    };
                    reader.readAsText(file);
                }
            }
        }

        function addSoulToList(soul) {
            const container = document.getElementById('soulList');
            const card = document.createElement('div');
            card.className = 'soul-card';

            // Random ID for removing
            const soulId = Date.now() + Math.random();
            soul.id = soulId;

            card.innerHTML = `
                <div class="soul-info" onclick="showSoulModalById('${soulId}')">
                    <div class="soul-name">${soul.name}</div>
                    <div class="soul-archetype">${soul.archetype}</div>
                </div>
                <div class="soul-remove" onclick="removeSoul('${soulId}', this)">&times;</div>
            `;

            container.appendChild(card);
            loadedSouls.push(soul);
            updateSoulCount();
        }

        function removeSoul(id, btn) {
            loadedSouls = loadedSouls.filter(s => s.id != id);
            btn.closest('.soul-card').remove();
            updateSoulCount();
        }

        function updateSoulCount() {
            document.getElementById('soulCount').textContent = `${loadedSouls.length} de 5 personajes`;
        }

        function showSoulModalById(id) {
            const soul = loadedSouls.find(s => s.id == id);
            if (soul) showSoulModal(soul);
        }

        function showSoulModal(soul) {
            const modal = document.getElementById('soulModal');
            const details = document.getElementById('soulDetails');
            details.innerHTML = `
                <h2>${soul.name}</h2>
                <div style="color:var(--gold-dim); margin-bottom:10px; font-size: 0.8rem;">ARCHIVO: ${soul.archetype}</div>
                <p>${soul.bio}</p>
                <div class="stat-grid">
                    ${soul.stats.map(s => `<div>• ${s}</div>`).join('')}
                </div>
            `;
            modal.style.display = 'flex';
        }

        function closeSoulModal() {
            document.getElementById('soulModal').style.display = 'none';
        }

        function toggleGuide() {
            const modal = document.getElementById('guideModal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
            }
        }
        // === AUDIO & ATMOSPHERE (Refactored) ===
        const AUDIO_STATE = {
            current: null
        };

        const FIRE_SOURCES = [
            "https://actions.google.com/sounds/v1/ambiences/fire.ogg",
            "https://upload.wikimedia.org/wikipedia/commons/d/d7/Fire_burning.ogg",
            "https://freesound.org/data/previews/173/173874_2181711-lq.mp3"
        ];
        let currentFireIndex = 0;

        function handleFireError(audioEl) {
            currentFireIndex++;
            if (currentFireIndex < FIRE_SOURCES.length) {
                console.warn(`Fire source failed, trying source ${currentFireIndex}: ${FIRE_SOURCES[currentFireIndex]}`);
                audioEl.src = FIRE_SOURCES[currentFireIndex];
                audioEl.load();
            } else {
                console.error("All fire audio sources failed.");
                addAriaMsg('system', '⚠️ Fuego: Todas las fuentes fallaron.');
            }
        }

        function playAmbience(type) {
            const id = `sfx-${type}-new`;
            const el = document.getElementById(id);
            const btn = document.querySelector(`button[onclick="playAmbience('${type}')"]`);

            if (!el) return console.error("Audio element not found:", id);

            // Stop others
            ['rain', 'fire', 'tavern'].forEach(t => {
                if (t !== type) {
                    const other = document.getElementById(`sfx-${t}-new`);
                    const otherBtn = document.querySelector(`button[onclick="playAmbience('${t}')"]`);
                    if (other) {
                        other.pause();
                        if (otherBtn) otherBtn.classList.remove('active');
                    }
                }
            });

            // Toggle Current
            if (el.paused) {
                const playPromise = el.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        el.volume = 0.5;
                        if (btn) btn.classList.add('active');
                        AUDIO_STATE.current = type;
                        addAriaMsg('user', `🎵 Ambiente activado: ${type.toUpperCase()}`);
                    }).catch(error => {
                        console.error("Auto-play prevented:", error);
                        addAriaMsg('system', "⚠️ Error: Interactúa con la página para activar audio.");
                    });
                }
            } else {
                el.pause();
                if (btn) btn.classList.remove('active');
                AUDIO_STATE.current = null;
            }
        }

        function setGlobalVolume(val) {
            ['rain', 'fire', 'tavern'].forEach(t => {
                const el = document.getElementById(`sfx-${t}-new`);
                if (el) el.volume = val;
            });
        }

        function getLastParagraph() {
            const editor = document.getElementById('editor');
            const text = editor.innerText.trim();
            if (!text) return "";
            const lines = text.split('\n').filter(l => l.trim() !== "");
            return lines[lines.length - 1] || "";
        }

        function updateGlow(tensionVal) {
            const glowBase = document.getElementById('fire-glow-base');
            const glowFlicker = document.getElementById('fire-glow-flicker');

            // Fallback for safety if elements missing
            if (!glowBase || !glowFlicker) return;

            // Base opacity 0.3 + up to 0.5 based on tension
            const opacity = 0.3 + (tensionVal / 200);

            // Color shift: from Orange (Low Tension) to Red (High Tension)
            const red = 255;
            const green = Math.max(0, 100 - tensionVal); // Green drops as tension rises

            glowBase.style.background = `radial-gradient(ellipse at center bottom, rgba(${red}, ${green}, 0, 0.4) 0%, transparent 70%)`;
            glowBase.style.opacity = opacity;

            glowFlicker.style.opacity = opacity + 0.1;
        }

        // Hook into SuggestChaos to flare the light
        // Note: We need to redefine it or wrap it carefully since it's defined above
        // We will just wrap it here as we are at the end of the script
        const _originalSuggestChaos = suggestChaos;
        suggestChaos = async function () {
            // Visual Flare
            const glowFlicker = document.getElementById('fire-glow-flicker');
            if (glowFlicker) {
                glowFlicker.classList.remove('glow-chaos');
                void glowFlicker.offsetWidth; // trigger reflow
                glowFlicker.classList.add('glow-chaos');
            }
            // Call original
            await _originalSuggestChaos();
        }

        // Hook into updateTensionUI
        const _originalUpdateTension = updateTensionUI;
        updateTensionUI = function (val, type) {
            _originalUpdateTension(val, type);
            updateGlow(val);
        }
    </script>

</body>

</html>