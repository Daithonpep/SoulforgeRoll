<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soulforge: The Living Chronicle (V6 - Witcher Style)</title>

    <!-- CSS NUCLEAR & REACTIVE SYSTEM (V3) -->
    <style>
        /* ============ RESET & BASE ============ */
        :root {
            --gold: #c9a959;
            --black: #050505;
            --cyan-ether: #00f3ff;
            --blood-mist: rgba(130, 0, 0, 0.4);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--black);
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            transition: background 1s ease;
        }

        /* ============ BACKGROUND ============ */
        .background-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
        }

        .background-image {
            width: 100%;
            height: 100%;
            background-image: url('lobby.png');
            background-size: cover;
            background-position: center;
            filter: blur(2px) brightness(0.3);
            transition: all 1s ease;
        }

        /* AMBIENTE REACTIVO */
        .atmosphere-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background: transparent;
            transition: background 2s ease;
            mix-blend-mode: overlay;
        }

        /* ============ MASSIVE PANEL (SPLASH) ============ */
        #connection-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .panel-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .war-room-title {
            font-family: 'Cinzel', serif;
            font-size: 10vw !important;
            font-weight: 700;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1vw;
            text-shadow: 0 0.5vh 2vh rgba(0, 0, 0, 0.9);
            margin: 0 0 8vh 0;
            text-align: center;
            line-height: 1;
        }

        .premium-input {
            width: 60vw !important;
            height: 10vh !important;
            font-size: 4vh !important;
            font-family: 'Cinzel', serif;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            border: 0.4vh solid #555;
            border-radius: 1vh;
            color: #fff;
            margin-bottom: 4vh;
        }

        .premium-input::placeholder {
            font-size: 3vh;
            letter-spacing: 0.2vw;
            color: #666;
        }

        .action-row {
            display: flex;
            align-items: center;
            gap: 2vw;
            width: 80vw;
            justify-content: center;
        }

        .btn-large {
            height: 10vh !important;
            padding: 0 4vw;
            font-family: 'Cinzel', serif;
            font-size: 2.5vh !important;
            font-weight: bold;
            cursor: pointer;
            border-radius: 1vh;
            border-width: 0.4vh;
            flex: 1;
            max-width: 30vw;
        }

        .btn-gold {
            background: var(--gold);
            color: black;
            border-color: var(--gold);
            box-shadow: 0 0 3vh rgba(201, 169, 89, 0.4);
            border-style: solid;
        }

        .btn-outline {
            background: transparent;
            color: var(--gold);
            border-color: var(--gold);
            border-style: solid;
        }

        .divider-text {
            color: #666;
            font-family: 'Cinzel';
            font-size: 4vh;
        }

        .hidden {
            display: none !important;
        }

        /* ============ LOBBY REACTIVO (CIRCULAR GRID) ============ */
        #lobby-ui {
            z-index: 100;
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .lobby-header {
            padding: 4vh;
            text-align: center;
        }

        .lobby-status {
            font-family: 'Cinzel';
            color: #888;
            letter-spacing: 2px;
            font-size: 2vh;
            margin-top: 1vh;
        }

        .soul-counter {
            color: var(--gold);
            font-weight: bold;
        }

        /* GRID DE RETRATOS (CIRCULAR TOKENS) */
        .soul-grid-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3vw;
            padding: 0 5vw;
        }

        .soul-card {
            width: 18vw;
            height: 18vw;
            /* Square for circle */
            background: rgba(10, 10, 10, 0.6);
            border: 2px dashed #444;
            border-radius: 50%;
            /* CIRCULO PERFECTO */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.5s ease;
            position: relative;
        }

        .soul-card.empty::after {
            content: '?';
            font-family: 'Cinzel';
            font-size: 5vw;
            color: #333;
        }

        .soul-card.filled {
            background-color: black;
            border: 4px solid #666;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .soul-card.filled img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            pointer-events: none;
        }

        .soul-info {
            position: absolute;
            bottom: -5vh;
            width: 150%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cinzel';
            color: #ccc;
            font-size: 1.5vw;
            font-weight: bold;
            text-shadow: 0 2px 5px black;
            background: transparent;
        }

        /* UPLOAD ZONE */
        .upload-zone {
            border: 2px dashed var(--gold);
            background: rgba(0, 0, 0, 0.6);
            width: 60vw;
            height: 30vh;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            background: rgba(201, 169, 89, 0.2);
            transform: scale(1.02);
        }

        50% {
            box-shadow: 0 0 50px #9d00ff;
            transform: scale(1.02);
        }
        }

        .soul-card.ready-flash {
            animation: flashReady 0.5s ease-out;
        }

        @keyframes pulseAura {
            0% {
                box-shadow: 0 0 20px var(--cyan-ether);
            }

            50% {
                box-shadow: 0 0 50px var(--cyan-ether);
            }

            100% {
                box-shadow: 0 0 20px var(--cyan-ether);
            }
        }

        @keyframes flashReady {
            0% {
                filter: brightness(1);
                transform: scale(1);
            }

            50% {
                filter: brightness(2);
                transform: scale(1.1);
            }

            100% {
                filter: brightness(1);
                transform: scale(1);
            }
        }

        /* CONTROLES */
        .lobby-controls {
            padding: 4vh;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .mute-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #555;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
        }

        .mute-btn:hover {
            background: white;
            color: black;
        }

        /* Game UI */
        .game-ui {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        .dm-console {
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            display: none;
        }

        .the-quill {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 8px;
            display: none;
        }

        #game-ui.active .dm-console,
        #game-ui.active .the-quill {
            display: block;
        }
    </style>
</head>

<body>
    <!-- World Container -->
    <div id="world-container">
        <canvas id="world-canvas"></canvas>
        <div id="map-tokens-layer"></div>
        <div class="particle-layer" id="particles"></div>
        <canvas id="fog-canvas"></canvas>
    </div>

    <!-- Weather & Atmosphere -->
    <div id="weather-layer">
        <div class="weather-overlay"></div>
    </div>
    <div id="atmosphere-overlay" class="atmosphere-overlay"></div>

    <!-- Background Layers -->
    <div class="background-layer">
        <div class="background-image"></div>
    </div>

    <!-- CONNECTION PANEL (Paso 1: Login) -->
    <div id="connection-panel">
        <div class="panel-content">
            <h1 class="war-room-title">THE WAR ROOM</h1>
            <input type="text" id="room-code-input" class="premium-input" placeholder="C칍DIGO DE SALA (SOLO JUGADORES)">
            <div class="action-row">
                <button class="btn-large btn-gold" onclick="WarRoomUI.createRoom()">CREAR NUEVA SALA</button>
                <div class="divider-text">O</div>
                <button class="btn-large btn-outline" onclick="WarRoomUI.joinRoom()">UNIRSE A PARTIDA</button>
            </div>
        </div>
    </div>

    <!-- UPLOAD CHARACTER UI (Paso 2: Identificaci칩n) -->
    <div id="character-upload-ui" class="hidden"
        style="position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:99999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <h1 class="war-room-title" style="font-size: 6vw !important; margin-bottom: 4vh;">IDENTIF칈CATE</h1>

        <div class="upload-zone" onclick="document.getElementById('char-file-input').click()">
            <span style="font-size:4vw; display:block; margin-bottom:2vh;">游닆</span>
            <span style="font-family:'Cinzel'; font-size:2vw; color:#ccc;">CLICK PARA SELECCIONAR TU FICHA
                (.JSON)</span>
            <input type="file" id="char-file-input" style="display:none" accept=".json"
                onchange="WarRoomUI.handleFileUpload(this)">
        </div>
    </div>

    <!-- LOBBY UI (Paso 3: Espera y Sintonizaci칩n Circulares) -->
    <div id="lobby-ui" class="lobby-ui hidden">
        <!-- Header Info -->
        <div class="lobby-header">
            <h2 style="font-family:'Cinzel'; color:white; font-size:3vw; margin:0;">SINTONIZANDO ALMAS</h2>
            <div class="lobby-status">
                ALMAS SINTONIZADAS: <span id="soul-counter" class="soul-counter">0/4</span> | SALA: <span
                    id="code-display-lobby">---</span>
            </div>
        </div>

        <!-- The Portrait Grid (Circular) -->
        <div class="soul-grid-container" id="soul-grid">
            <div class="soul-card empty"></div>
            <div class="soul-card empty"></div>
            <div class="soul-card empty"></div>
            <div class="soul-card empty"></div>
        </div>

        <!-- Bottom Controls -->
        <div class="lobby-controls">
            <button class="mute-btn" onclick="WarRoomUI.toggleMute()" title="Silenciar M칰sica">游댉</button>
        </div>
    </div>

    <!-- GAME UI (Initial Hidden State) -->
    <div id="game-ui" class="game-ui hidden">
        <div class="dm-toolbar"></div>
        <div class="dm-console"></div>
        <div class="the-quill">
            <input type="text" id="cmd-input" placeholder="Escribe comandos..." style="width:100%; padding: 10px;">
        </div>
    </div>

    <!-- SCRIPT LOGIC (WarRoomUI V3) -->
    <script>
        const WarRoomUI = {
            bgm: null,
            myCharacter: null,

            createRoom: () => {
                const code = 'ROOM-' + Math.floor(Math.random() * 9000 + 1000);
                localStorage.setItem('soulforge_role', 'DM');
                localStorage.setItem('soulforge_room', code);

                const btn = document.querySelector('.btn-gold');
                btn.innerText = "FORJANDO SALA...";
                btn.style.opacity = 0.8;

                setTimeout(() => {
                    window.location.href = `configuracion_destino.html?room=${code}&dm=true`;
                }, 800);
            },

            joinRoom: () => {
                const code = document.getElementById('room-code-input').value.trim();
                if (!code) return alert("Por favor, introduce el C칍DIGO DE LA SALA.");

                localStorage.setItem('soulforge_role', 'PLAYER');
                localStorage.setItem('soulforge_room', code);

                // PASO 1: Ir a Upload
                document.getElementById('connection-panel').classList.add('hidden');
                document.getElementById('character-upload-ui').classList.remove('hidden');

                // Audio
                this.bgm = new Audio('lobby_theme.wav');
                this.bgm.loop = true;
                this.bgm.volume = 0.5;
                this.bgm.play().catch(e => console.log("Audio requires interaction"));
            },

            handleFileUpload: (input) => {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            WarRoomUI.myCharacter = json;

                            // PASO 2: Ir a Lobby
                            document.getElementById('character-upload-ui').classList.add('hidden');
                            document.getElementById('lobby-ui').classList.remove('hidden');

                            document.getElementById('code-display-lobby').innerText = localStorage.getItem('soulforge_room');
                            WarRoomUI.renderMyToken(json);

                        } catch (err) {
                            alert("Error: El archivo no es un JSON v치lido.");
                        }
                    };
                    reader.readAsText(input.files[0]);
                }
            },

            renderMyToken: (charData) => {
                const name = charData.identidad ? charData.identidad.nombre : "Desconocido";
                const imgUrl = charData.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`;

                // Determine Tier
                let tierClass = 'tier-d'; // Default: Bronce

                // 1. Explicit Tier in JSON
                if (charData.tier) {
                    const t = charData.tier.toLowerCase();
                    if (['e', 'd', 'c', 'b', 'a', 's', 'ss', 'sss'].includes(t)) {
                        tierClass = `tier-${t}`;
                    }
                }
                // 2. Fallback: Calculate from attributes (Power)
                else if (charData.attributes && charData.attributes.power) {
                    const p = charData.attributes.power;
                    if (p >= 99) tierClass = 'tier-sss';
                    else if (p >= 95) tierClass = 'tier-ss';
                    else if (p >= 90) tierClass = 'tier-s';
                    else if (p >= 80) tierClass = 'tier-a';
                    else if (p >= 60) tierClass = 'tier-b';
                    else if (p >= 40) tierClass = 'tier-c';
                }

                // Fill first empty slot
                const slot = document.querySelector('#soul-grid .soul-card.empty');
                if (slot) {
                    slot.className = `soul-card filled ready-flash ${tierClass}`;
                    slot.innerHTML = `<img src="${imgUrl}"><div class="soul-info">${name}</div>`;

                    // Update counter (Simulated increment)
                    const current = parseInt(document.getElementById('soul-counter').innerText.split('/')[0]) || 0;
                    document.getElementById('soul-counter').innerText = `${current + 1}/4`;
                }
            },

            toggleMute: () => {
                if (!WarRoomUI.bgm) return;
                WarRoomUI.bgm.muted = !WarRoomUI.bgm.muted;
            }
        };
    </script>

    <!-- Legacy Director Logic -->
    <script type="module">
        // Basic Director Logic to prevent errors if files missing
        window.Director = {
            init: () => console.log("Director initialized"),
            processCommand: (cmd) => console.log("CMD:", cmd)
        };
    </script>
    <!-- Override Logic for Lore Tiers -->
    <script>
        // Redefinir renderMyToken para asegurar l칩gica de Lore
        if (window.WarRoomUI) {
            WarRoomUI.renderMyToken = (charData) => {
                const name = charData.identidad ? charData.identidad.nombre : "Desconocido";
                const imgUrl = charData.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`;

                // Determine Tier (Lore System)
                let tierClass = 'tier-eco'; // Default: Eco

                // 1. Explicit Tier in JSON
                if (charData.tier) {
                    const t = charData.tier.toLowerCase().replace(' ', '_'); // "alma primordial" -> "alma_primordial"
                    if (['eco', 'sombra', 'alma', 'alma_primordial'].includes(t)) {
                        tierClass = `tier-${t}`;
                    }
                }
                // 2. Fallback: Calculate from Power Attribute
                else if (charData.attributes && charData.attributes.power) {
                    const p = charData.attributes.power;
                    if (p >= 90) tierClass = 'tier-alma-primordial';
                    else if (p >= 50) tierClass = 'tier-alma';
                    else if (p >= 20) tierClass = 'tier-sombra';
                    else tierClass = 'tier-eco';
                }

                const slot = document.querySelector('#soul-grid .soul-card.empty');
                if (slot) {
                    slot.className = `soul-card filled ready-flash ${tierClass}`;
                    slot.innerHTML = `<img src="${imgUrl}"><div class="soul-info">${name}</div>`;

                    const elCounter = document.getElementById('soul-counter');
                    const current = parseInt(elCounter.innerText.split('/')[0]) || 0;
                    elCounter.innerText = `${current + 1}/4`;
                }
            };
        }
    </script>
</body>

</html>